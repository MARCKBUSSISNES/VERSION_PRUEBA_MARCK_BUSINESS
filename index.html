<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>MT ROPA ONLINE ATLANTIC PLAZA</title>

  <style>
    :root{
      --bg:#000000;
      --panel:#e09898;
      --panel2:rgba(192, 191, 255, 0.905);
      --text:#000000;
      --muted:#94b4ff;

      --pink:#ff4fb7;
      --purple:#a855f7;
      --rose:#fb7185;

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --border:rgba(36, 20, 40, .10);
      --shadow: 0 16px 40px rgba(20, 10, 25, .10);
      --shadow2: 0 10px 26px rgba(20, 10, 25, .07);

      --radius: 22px;
      --radius2: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;

      --focus: 0 0 0 4px rgba(255, 79, 182, 0.332);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      overflow-x:hidden;

      background:
        radial-gradient(900px 650px at 18% 8%, rgba(255,79,183,.20), transparent 55%),
        radial-gradient(800px 520px at 85% 5%, rgba(168,85,247,.20), transparent 60%),
        radial-gradient(700px 520px at 70% 90%, rgba(251,113,133,.16), transparent 55%),
        var(--bg);
    }

    /* subtle floating sparkles */
    .sparkle{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.35;
      mix-blend-mode:multiply;
      background-image:
        radial-gradient(circle at 12% 18%, rgba(255,79,183,.22) 0 2px, transparent 3px),
        radial-gradient(circle at 84% 22%, rgba(168,85,247,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 78%, rgba(251,113,133,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 28% 72%, rgba(255,79,183,.14) 0 2px, transparent 3px);
      animation: drift 12s ease-in-out infinite alternate;
      filter: blur(.2px);
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) scale(1); }
      to{ transform: translate3d(-10px, 8px, 0) scale(1.02); }
    }

    .app{
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }

    /* Sidebar */
    .sidebar{
      position: sticky;
      top: 14px;
      align-self: start;
      height: calc(100vh - 28px);
      background: linear-gradient(180deg, rgba(230, 7, 193, 0.92) 0%, rgba(0, 0, 0, 0.92) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;

      animation: pop .35s ease-out both;
    }
    @keyframes pop{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .brand h1{
      font-size: 15px;
      margin:0;
      line-height:1.15;
      letter-spacing:.2px;
      font-weight: 1000;
    }
    .brand small{display:block;color:var(--muted); font-weight:800; margin-top:2px}

    .hamburger{
      width:42px;height:42px;border-radius:16px;
      border:1px solid var(--border);
      background:#000000;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(17,10,20,.07);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .hamburger:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(17,10,20,.10); }
    .hamburger:active{ transform: translateY(0); }
    .burger{ width:18px;height:12px; position:relative; }
    .burger span{
      position:absolute; left:0; right:0;
      height:2px; border-radius:999px;
      background: linear-gradient(90deg, var(--pink), var(--purple));
    }
    .burger span:nth-child(1){top:0}
    .burger span:nth-child(2){top:5px}
    .burger span:nth-child(3){bottom:0}

    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: var(--shadow2);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(164, 86, 204, 0.09);
    }
    .nav button .tag{
      font-weight:1000;
      font-size:12px;
      padding: 4px 10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,79,183,.14), rgba(168,85,247,.14));
      color: #7b2fb4;
      border:1px solid rgba(168,85,247,.18);
      white-space:nowrap;
    }
    .nav button.active{
      border-color: rgba(255,79,183,.55);
      box-shadow: 0 18px 34px rgba(255,79,183,.18);
      background: linear-gradient(180deg, #fff 0%, #fff1fa 100%);
    }

    .sidecard{
      margin-top:14px;
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,79,183,.38);
      background: rgba(255,255,255,.84);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      color:#7b2fb4;
      background: rgba(168,85,247,.12);
      border:1px solid rgba(168,85,247,.25);
      padding: 6px 10px;
      border-radius:999px;
    }
    .sidecard .row{
      display:flex; justify-content:space-between; gap:10px; margin:8px 0;
      color:var(--muted); font-weight:800;
    }
    .sidecard .row b{color:var(--text)}

    /* Main */
    .main{
      min-height: calc(100vh - 36px);
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      overflow: visible; /* key: don't cut the right card */
      animation: pop .35s ease-out both;
      max-width:100%;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 6px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 14px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h2{margin:0;font-size:18px}
    .title p{margin:0;color:var(--muted);font-weight:800;font-size:13px}

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      border:none;
      cursor:pointer;
      font-weight:1000;
      padding: 11px 14px;
      border-radius: 16px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow: 0 10px 22px rgba(135, 77, 160, 0.06);
      color:var(--text);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 16px 30px rgba(17,10,20,.09); }
    .btn:active{ transform: translateY(0); }
    .btn.small{ padding:9px 12px; border-radius:14px; font-weight:1000; }

    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--purple));
      color:white;
      border:none;
      box-shadow: 0 16px 34px rgba(255,79,183,.26);
    }
    .btn.ok{
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(34,197,94,.22);
    }
    .btn.danger{
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(239,68,68,.22);
    }

    /* Key: minmax(0,...) prevents horizontal overflow from inputs/selects */
    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap: 14px;
      margin-top: 14px;
    }

    .card, .field, .rowflex, .table{ min-width:0; }

    .card{
      background: rgba(255,255,255,.90);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
      position:relative;
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      opacity:0;
      border-radius: calc(var(--radius) + 2px);
      background: radial-gradient(700px 180px at 20% 0%, rgba(255,79,183,.12), transparent 50%),
                  radial-gradient(700px 180px at 80% 0%, rgba(168,85,247,.12), transparent 50%);
      transition: opacity .22s ease;
    }
    .card:hover::after{ opacity:1; }

    .card h3{margin:0 0 10px 0; font-size:15px; font-weight:1000}
    .muted{color:var(--muted); font-weight:800; font-size:13px}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .field input, .field select, .field textarea{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-weight:900;
      color:var(--text);
      min-width:0;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(255,79,183,.55);
      box-shadow: var(--focus);
    }

    .field.full{grid-column:1 / -1}

    .rowflex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .rowflex .grow{ flex:1; }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-weight:900;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      background: rgba(255,79,183,.09);
      color:#6b1f5b;
    }
    .table td small{color:var(--muted); font-weight:900}
    .table tr:last-child td{border-bottom:none}

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      padding:12px;
      border-radius: var(--radius2);
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(17,10,20,.05);
    }
    .kpi .label{ color:var(--muted); font-weight:1000; font-size:12px }
    .kpi .value{ font-size:18px; font-weight:1100; margin-top:4px }
    .kpi .value span{ font-size:12px; color:var(--muted); font-weight:1000 }

    .hide{ display:none !important; }
.hidden{ display:none !important; }

    /* Receipt */
    .receiptWrap{ display:flex; gap:12px; flex-wrap:wrap; }
    .receipt{
      width: 360px; /* default; can be overridden dynamically for ENV√çO */
      background: #ffffff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 34px rgba(0,0,0,.11);
      transform-origin: top center;
      animation: floatIn .35s ease-out both;
      position:relative;
    }
    .cornerLogo{
      position:absolute;
      top:10px;
      right:10px;
      width:60px;
      height:60px;
      object-fit:contain;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      padding:4px;
    }
    @keyframes floatIn{
      from{ transform: translateY(10px) scale(.98); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .receipt .logo{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      margin-bottom:10px;
      padding-right:60px; /* espacio para logo esquina */
    }
    .receipt .logo b{ font-size:14px; letter-spacing:.3px; }
    .receipt .logo small{ display:block; color:#666; font-weight:900 }
    .receipt .line{ display:flex; justify-content:space-between; gap:10px; font-weight:1000; font-size:12px; margin:6px 0 }
    .receipt .line{ align-items:flex-start; }
    .receipt .line span:first-child{ flex:0 0 90px; }
    .receipt .line span:last-child{ flex:1 1 auto; text-align:right; word-break:break-word; overflow-wrap:anywhere; }
    .receipt.envio .line{ font-size:11px; }
    .receipt.envio .big{ font-size:14px; }
    .receipt .hr{ height:1px; background:rgba(0,0,0,.08); margin:10px 0 }
    .receipt .big{ font-size:16px; font-weight:1200; display:flex; justify-content:space-between; margin-top:10px; }
    .receipt .foot{ margin-top:10px; font-size:11px; color:#666; font-weight:900 }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      font-size:11px;
      padding: 4px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.7);
      margin-top:6px;
    }
    .badge.pending{ border-color: rgba(245,158,11,.40); background: rgba(245,158,11,.12); color:#7a4b00; }
    .badge.paid{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color:#0e5b2a; }

    /* Responsive */
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .receipt{ width:100%; }
    }

    /* Capture mode (para PNG n√≠tido, sin overlays) */
    body.capture-mode .sparkle{ display:none !important; }
    body.capture-mode #receiptBox,
    body.capture-mode #closeBox{
      opacity: 1 !important;
      filter: none !important;
      transform: none !important;
    }

  </style>
</head>
<body>
  <div class="sparkle"></div>
<div class="menuOverlay" id="menuOverlay"></div>
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
  <img src="LOGO1.png" alt="Logo" style="
    width:90px;
    height:90px;
    object-fit:contain;
    border-radius:12px;
  ">
  <div>
    <h1>MTR ONLINE <small>ATLANTIC PLAZA</small></h1>
  </div>
        <button class="hamburger" id="btnToggle" title="Men√∫">
          <div class="burger"><span></span><span></span><span></span></div>
        </button>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="pos"><span>üßæ Registro de Ventas</span><span class="tag">VENTA</span></button>
        <button data-view="shipments"><span>üöö Env√≠os pendientes</span><span class="tag">ENV√çO</span></button>
        <button data-view="clients"><span>üë©‚Äçüíº Clientes</span><span class="tag">DB</span></button>
        <button data-view="reports"><span>üìä Reportes</span><span class="tag">D/W/M</span></button>
        <button data-view="products"><span>üß∑ Productos</span><span class="tag">SKU</span></button>
        <button data-view="inventory"><span>üì¶ Inventarios</span><span class="tag">STOCK</span></button>
        <button data-view="kardex"><span>üìä</span><b>Kardex</b><i>Movimientos</i></button>
<button data-view="close"><span>üßæ Cierres</span><span class="tag">D√çA</span></button>
        <button data-view="settings"><span>‚öôÔ∏è Ajustes</span><span class="tag">LOCAL</span></button>
      </div>

      <div class="sidecard">
        <div class="pill">üíó TUS VENTAS HOY</div>
        <div class="row"><span>Clientes</span><b id="kClients">0</b></div>
        <div class="row"><span>Productos</span><b id="kProducts">0</b></div>
        <div class="row"><span>Ventas (hoy)</span><b id="kSalesToday">0</b></div>
        <div class="row"><span>Total (hoy)</span><b id="kTotalToday">Q0.00</b></div>
        <div class="row"><span>Env√≠os pendientes</span><b id="kShipPending">0</b></div>
        <div class="muted" style="margin-top:10px">
          Tip: usa <b>Escanear</b> y pasa el lector. (F2 enfoca el campo)
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="viewTitle">DASH PRINCIPAL</h2>
          <p id="viewSub">Soporte tecnico tel: 58140-621</p>
        </div>
        <div class="actions">
          <button class="btn small" id="btnBackup">Exportar Back Up</button>
          <button class="btn small" id="btnRestore">Importar Back Up</button>
	  <button id="btnPickBackupFolder">üìÅ Elegir carpeta de Backups</button>
        </div>
      </div>

      <!-- POS VIEW -->
      <section id="view-pos">
        <div class="grid">
          <div class="card">
            <h3>üßæ Venta</h3>

            <div class="form" style="margin-bottom:10px">
              <div class="field full">
                <label>Escanear c√≥digo de barras (SKU / C√≥digo)</label>
                <div class="rowflex">
                  <input id="scanInput" class="grow" inputmode="text" placeholder="ESCANEE EL CODIGO DE BARRAS" autocomplete="off" />
                  <button class="btn primary" id="btnScan">Escanear</button>
                </div>
                <div class="muted">.</div>
              </div>

              <div class="field">
                <label>Cantidad</label>
                <input id="qtyInput" type="number" min="1" value="1"/>
              </div>
              <div class="field">
                <label>Buscar producto (por nombre)</label>
                <input id="productSearch" placeholder="Ej: blusa, jeans..." />
              </div>

              <div class="field full">
                <label>Productos encontrados</label>
                <div class="rowflex">
                  <select id="productPicker" class="grow"></select>
                  <button class="btn" id="btnAddPicked">Agregar</button>
                </div>
              </div>
            </div>

            <table class="table" id="cartTable">
              <thead>
                <tr>
                  <th style="width:70px">Cant</th>
                  <th>Producto</th>
                  <th style="width:110px">Precio</th>
                  <th style="width:110px">Total</th>
                  <th style="width:110px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>

            <div class="totals">
              <div class="kpi">
                <div class="label">Subtotal</div>
                <div class="value" id="subTotal">Q0.00</div>
              </div>
              <div class="kpi">
                <div class="label">Total</div>
                <div class="value" id="grandTotal">Q0.00 <span>(Q)</span></div>
              </div>
            </div>

            <div class="muted" style="margin-top:8px">
              Descuento aplicado: <b id="discTotal">Q0.00</b>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∏ Descuento</h3>
              <div class="rowflex">
                <select id="discType" class="grow">
                  <option value="NONE">SIN DESCUENTO</option>
                  <option value="Q">DESCUENTO (Q)</option>
                  <option value="PCT">DESCUENTO (%)</option>
                </select>
               <input id="discValue" type="number" min="0" step="0.01" value="0" style="max-width:160px">
                <button class="btn" id="btnApplyDisc">Aplicar</button>
                <button class="btn danger" id="btnClearDisc">Quitar</button>
              </div>
              <div class="muted" style="margin-top:8px">
                El descuento se refleja en el ticket/PDF/PNG y el texto de WhatsApp.
              </div>
            </div>

            <div class="rowflex" style="margin-top:12px">
              <button class="btn" id="btnClearCart">Limpiar</button>
              <button class="btn ok" id="btnCheckout">Cobrar</button>
            </div>

            <div class="muted" style="margin-top:10px">
              *Si eliges <b>ENV√çO</b>, se crea un <b>env√≠o pendiente</b>. Solo al marcarlo como <b>PAGADO</b> contar√° como venta.
            </div>
          </div>

          <div class="card">
            <h3>üí≥ Pago + Cliente</h3>

            <div class="form">
              <div class="field">
                <label>Forma de pago</label>
                <select id="payMethod">
                  <option value="EFECTIVO">EFECTIVO</option>
                  <option value="TARJETA">TARJETA</option>
                  <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                </select>
              </div>

              <div class="field">
                <label>Tipo de venta</label>
                <select id="saleType">
                  <option value="MOSTRADOR">MOSTRADOR</option>
                  <option value="ENVIO">ENV√çO</option>
                </select>
              </div>

              <div class="field full">
                <label>Tel√©fono (para buscar/crear cliente)</label>
                <div class="rowflex">
                  <input id="cPhone" class="grow" placeholder="Ej: 5555-5555" />
                  <button class="btn" id="btnFindClient">Buscar</button>
                </div>
                <div class="muted">En <b>ENV√çO</b> es obligatorio tener cliente.</div>
              </div>

              <div class="field">
                <label>Nombres</label>
                <input id="cNames" placeholder="Ej: Karina"/>
              </div>
              <div class="field">
                <label>Apellidos</label>
                <input id="cLast" placeholder="Ej: L√≥pez"/>
              </div>

              <div class="field full">
                <label>Direcci√≥n</label>
                <textarea id="cAddr" rows="3" placeholder="Ej: Col. X, casa #, zona..., referencias..."></textarea>
              </div>

              <div class="field full">
                  <label>Indicaciones (referencias / comentario)</label>
                  <textarea id="cIndic" rows="3" placeholder="Ej: Port√≥n negro, llamar al llegar, casa con rejas..."></textarea>
              </div>

              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveClient">Guardar cliente</button>
                  <button class="btn" id="btnUseWalkIn">Venta sin cliente</button>
                </div>
                <div class="muted">‚ÄúVenta sin cliente‚Äù solo aplica para MOSTRADOR.</div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üßæ Comprobante</h3>
              <div class="rowflex">
                <button class="btn" id="btnCopyReceipt">Copiar texto</button>
                <button class="btn" id="btnPDF">PDF</button>
                <button class="btn" id="btnDownloadReceipt">PNG</button>
                <button class="btn primary" id="btnWhatsApp">WhatsApp</button>
              </div>
              <div class="muted" style="margin-top:10px">
                PDF abre impresi√≥n (Guardar como PDF). WhatsApp abre texto listo.
              </div>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="receiptBox">
                <img class="cornerLogo" src="LOGO1.png" onerror="this.style.display='none'" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="rShop">Tienda de Ropa</b>
                    <small id="rMeta">Recibo ‚Ä¢ Offline</small>
                    <div id="rStatusBadge" class="badge paid hide">‚úÖ PAGADO</div>
                  </div>
                  <div style="text-align:right">
                    <b id="rNo">#000001</b>
                    <small id="rDate">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Cliente</span><span id="rClient">MOSTRADOR</span></div>
                <div class="line"><span>Tel√©fono</span><span id="rPhone">‚Äî</span></div>
                <div class="line"><span>Direcci√≥n</span><span id="rAddr">‚Äî</span></div>
                <div class="line"><span>Indicaciones</span><span id="rIndic">‚Äî</span></div>
                <div class="hr"></div>

                <div id="rItems"></div>

                <div class="hr"></div>
                <div class="line" id="rSubLine"><span>Subtotal</span><span id="rSub">Q0.00</span></div>
                <div class="line" id="rDiscLine"><span>Descuento</span><span id="rDisc">Q0.00</span></div>
                <div class="line" id="rPayLine"><span>Pago</span><span id="rPay">EFECTIVO</span></div>
                <div class="big" id="rTotalLine"><span>Total</span><span id="rTotal">Q0.00</span></div>
                <div class="foot">¬°Gracias por tu compra! üíó</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SHIPMENTS VIEW -->
      <section id="view-shipments" class="hide">
        <div class="card">
          <h3>üöö Env√≠os pendientes (solo ENV√çO)</h3>
          <div class="rowflex">
            <input id="shipSearch" class="grow" placeholder="Buscar por tel√©fono, nombre o #recibo..."/>
            <select id="shipFilter" style="max-width:220px">
              <option value="ALL">Todos</option>
              <option value="PENDIENTE">Pendientes</option>
              <option value="PAGADO">Pagados</option>
            </select>
            <button class="btn" id="btnShipRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">
            Al cobrar en <b>ENV√çO</b>, el env√≠o queda <b>PENDIENTE</b>. Solo al marcar <b>PAGADO</b> se crea la venta (aparece en reportes/cierres).
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Recibo</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th>Estatus</th>
                  <th style="width:240px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="shipBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLIENTS VIEW -->
      <section id="view-clients" class="hide">
        <div class="card">
          <h3>üë©‚Äçüíº Clientes (base de datos local)</h3>
          <div class="rowflex">
            <input id="clientSearch" class="grow" placeholder="Buscar por tel√©fono o nombre..."/>
            <button class="btn" id="btnClientRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Tel√©fono es el identificador. Se guarda en tu navegador (IndexedDB).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Tel√©fono</th>
                  <th>Nombre</th>
                  <th>Direcci√≥n</th>
                  <th style="width:140px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="clientsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS VIEW -->
      <section id="view-reports" class="hide">
        <div class="card">
          <h3>üìä Reportes (Diario / Semanal / Mensual)</h3>

          <div class="rowflex">
            <button class="btn" id="btnRepDaily">Hoy</button>
            <button class="btn" id="btnRepWeekly">Semana</button>
            <button class="btn" id="btnRepMonthly">Mes</button>
          </div>
	 <div class="card" style="margin-top:12px">
  <h3 style="margin:0 0 10px 0">üïí Rango (Fecha + Hora)</h3>
  <div class="rowflex">
    <div class="field" style="min-width:180px">
      <label>Desde (fecha)</label>
      <input id="repFromDate" type="date">
    </div>
    <div class="field" style="min-width:160px">
      <label>Desde (hora)</label>
      <input id="repFromTime" type="time" value="00:00">
    </div>
    <div class="field" style="min-width:180px">
      <label>Hasta (fecha)</label>
      <input id="repToDate" type="date">
    </div>
    <div class="field" style="min-width:160px">
      <label>Hasta (hora)</label>
      <input id="repToTime" type="time" value="23:59">
    </div>
    <button class="btn primary" id="btnRepRange">Aplicar rango</button>
  </div>
  <div class="muted" style="margin-top:8px">
    Filtra ventas PAGADAS entre dos fechas/horas exactas.
  </div>
</div>

          <div class="totals" style="margin-top:12px">
            <div class="kpi">
              <div class="label">Ventas</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="kpi">
              <div class="label">Total</div>
              <div class="value" id="repTotal">Q0.00</div>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th style="width:160px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUCTS VIEW -->
      <section id="view-products" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üß∑ Productos (SKU / C√≥digo)</h3>
            <div class="form">
              <div class="field">
                <label>C√≥digo (SKU / Barras)</label>
                <input id="pCode" placeholder="Ej: 7501234567890"/>
              </div>
              <div class="field">
                <label>Nombre</label>
                <input id="pName" placeholder="Ej: Blusa rosa"/>
              </div>
              <div class="field">
                <label>Precio (Q)</label>
                <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ej: 125"/>
              </div>
              <div class="field">
                <label>Stock</label>
                <input id="pStock" type="number" min="0" step="1" placeholder="Ej: 10"/>
              </div>
              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveProduct">Guardar producto</button>
                </div>
                <div class="muted">Puedes agregar tus productos manualmente con c√≥digo, nombre, precio y stock.</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üì¶ Lista de productos</h3>
            <div class="rowflex">
              <input id="prodSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
              <button class="btn" id="btnProdRefresh">Refrescar</button>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>C√≥digo</th>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th style="width:140px">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="productsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- INVENTORY VIEW -->
      <section id="view-inventory" class="hide">
        <div class="card">
          <h3>üì¶ Inventarios (Stock actual)</h3>
          <div class="rowflex">
            <input id="invSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
            <button class="btn" id="btnInvRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Muestra el stock actual. Se descuenta autom√°ticamente al cobrar (y tambi√©n cuando se crea un env√≠o pendiente).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Stock</th>
                </tr>
              </thead>
              <tbody id="invBody"></tbody>
            </table>
          </div>
        </div>
      </section>
<section class="view hide" id="view-kardex">
  <div class="panel">
    <h2 style="margin:0 0 10px">Kardex perpetuo</h2>
    <div class="grid2">
      <div class="field">
        <label>Buscar (c√≥digo / nombre)</label>
        <input id="kSearch" class="input" placeholder="Ej: blusa, 12345..." />
      </div>
      <div class="field">
        <label>Tipo</label>
        <select id="kType" class="input">
          <option value="">Todos</option>
          <option value="INGRESO">INGRESO</option>
          <option value="AJUSTE">AJUSTE</option>
          <option value="SALIDA">SALIDA</option>
          <option value="ENTRADA">ENTRADA</option>
        </select>
      </div>
    </div>

    <div class="panel2" style="margin-top:12px; overflow:auto">
      <table class="tbl" style="min-width:860px">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>C√≥digo</th>
            <th>Producto</th>
            <th style="text-align:right">Cantidad</th>
            <th style="text-align:right">Stock</th>
            <th>Ref</th>
            <th>Nota</th>
          </tr>
        </thead>
        <tbody id="kBody"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:12px; gap:10px; flex-wrap:wrap">
      <button class="btn" id="btnKRefresh">Actualizar</button>
      <button class="btn danger" id="btnKClear" title="Esto borra el kardex (NO recomendado)">Borrar kardex</button>
    </div>
  </div>
</section>


      <!-- CLOSE VIEW -->
      <section id="view-close" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üßæ Cierres de ventas (m√∫ltiples por d√≠a)</h3>

            <div class="rowflex">
              <div class="field" style="min-width:220px">
                <label>Fecha</label>
                <input id="closeDate" type="date" />
              </div>
              <div class="field" style="min-width:180px">
                <label>Desde (hora)</label>
                <input id="closeFrom" type="time" value="00:00"/>
              </div>
              <div class="field" style="min-width:180px">
                <label>Hasta (hora)</label>
                <input id="closeTo" type="time" value="23:59"/>
              </div>
              <button class="btn primary" id="btnBuildClose">Generar cierre</button>
              <button class="btn ok" id="btnSaveClose">Guardar cierre</button>
            </div>

            <div class="muted" style="margin-top:10px">
              El cierre toma <b>solo ventas PAGADAS</b> dentro del rango (fecha + horas). Puedes guardar varios cierres por d√≠a.
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∞ Cuadre por forma de pago</h3>
              <div class="form">
                <div class="field">
                  <label>EFECTIVO contado (real)</label>
                  <input id="realCash" type="number" min="0" step="0.01" value="0"/>
                </div>
                <div class="field">
                  <label>TARJETA (real)</label>
                  <input id="realCard" type="number" min="0" step="0.01" value="0"/>
                </div>
                <div class="field full">
                  <label>TRANSFERENCIA (real)</label>
                  <input id="realTrans" type="number" min="0" step="0.01" value="0"/>
                </div>
              </div>
              <div class="muted" style="margin-top:8px">
                Diferencia = Real - Sistema. (positivo = sobra, negativo = falta)
              </div>
              <div class="totals">
                <div class="kpi">
                  <div class="label">Dif. EFECTIVO</div>
                  <div class="value" id="diffCash">Q0.00</div>
                </div>
                <div class="kpi">
                  <div class="label">Dif. TARJETA</div>
                  <div class="value" id="diffCard">Q0.00</div>
                </div>
              </div>
              <div class="totals">
                <div class="kpi">
                  <div class="label">Dif. TRANSFER.</div>
                  <div class="value" id="diffTrans">Q0.00</div>
                </div>
                <div class="kpi">
                  <div class="label">Dif. TOTAL</div>
                  <div class="value" id="diffTotal">Q0.00</div>
                </div>
              </div>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Pago</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="closeHistBody"></tbody>
              </table>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üóÇÔ∏è Historial de cierres guardados (por fecha)</h3>
              <div class="rowflex">
                <button class="btn" id="btnCloseListRefresh">Refrescar</button>
              </div>
              <div style="margin-top:10px; overflow:auto">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Rango</th>
                      <th>Ventas</th>
                      <th>Total</th>
                      <th style="width:180px">Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody id="closeSavedBody"></tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:8px">
                Borrar cierre guardado requiere c√≥digo <b>363534</b>.
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üìÑ Ticket de cierre</h3>
            <div class="rowflex">
              <button class="btn" id="btnCloseCopy">Copiar texto</button>
              <button class="btn" id="btnClosePDF">PDF</button>
              <button class="btn" id="btnClosePNG">PNG</button>
              <button class="btn primary" id="btnCloseWA">WhatsApp</button>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="closeBox">
                <img class="cornerLogo" src="LOGO1.png" onerror="this.style.display='none'" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="cShop">Tienda de Ropa</b>
                    <small id="cMeta">Cierre ‚Ä¢ D√≠a</small>
                  </div>
                  <div style="text-align:right">
                    <b id="cDate">‚Äî</b>
                    <small id="cTime">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Ventas</span><span id="cSales">0</span></div>
                <div class="line"><span>Mostrador</span><span id="cMost">0</span></div>
                <div class="line"><span>Env√≠os</span><span id="cEnv">0</span></div>
                <div class="hr"></div>

                <div class="line"><span>EFECTIVO</span><span id="cCash">Q0.00</span></div>
                <div class="line"><span>TARJETA</span><span id="cCard">Q0.00</span></div>
                <div class="line"><span>TRANSFER.</span><span id="cTrans">Q0.00</span></div>
                <div class="hr"></div>

                <div class="line"><span>Subtotal</span><span id="cSub">Q0.00</span></div>
                <div class="line"><span>Descuentos</span><span id="cDisc">Q0.00</span></div>
                <div class="big"><span>Total</span><span id="cTotal">Q0.00</span></div>

                <div class="hr"></div>
                <div class="muted">Cuadre (Real - Sistema)</div>
                <div class="line"><span>Real EFECTIVO</span><span id="cRealCash">Q0.00</span></div>
                <div class="line"><span>Dif. EFECTIVO</span><span id="cDiffCash">Q0.00</span></div>
                <div class="line"><span>Real TARJETA</span><span id="cRealCard">Q0.00</span></div>
                <div class="line"><span>Dif. TARJETA</span><span id="cDiffCard">Q0.00</span></div>
                <div class="line"><span>Real TRANSFER.</span><span id="cRealTrans">Q0.00</span></div>
                <div class="line"><span>Dif. TRANSFER.</span><span id="cDiffTrans">Q0.00</span></div>
                <div class="line"><span>Dif. TOTAL</span><span id="cDiffTotal">Q0.00</span></div>

                <div class="hr"></div>
                <div class="muted">Productos vendidos</div>
                <div id="cProducts" style="margin-top:8px"></div>

                <div class="foot">Cierre generado ‚úÖ</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="hide">
        <div class="card">
          <h3>‚öôÔ∏è Ajustes</h3>

          <div class="form">
            <div class="field full">
              <label>Nombre de la tienda (sale en el recibo)</label>
              <input id="sShopName" placeholder="Ej: Boutique Karina"/>
            </div>

            <div class="field">
              <label>Auto PDF al cobrar</label>
              <select id="sAutoPDF">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field">
              <label>Auto PNG al cobrar</label>
              <select id="sAutoPNG">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field full">
              <h3 style="margin:8px 0 0 0">üìè Tama√±os (solo para ENV√çO)</h3>
              <div class="muted">Cambiar estos tama√±os requiere c√≥digo <b>363534</b>. MOSTRADOR sigue con tama√±o actual.</div>
            </div>

            <div class="field">
              <label>PNG: Ancho recibo (px)</label>
              <input id="sEnvPngWidth" type="number" min="260" step="1" placeholder="Ej: 360"/>
            </div>

            <div class="field">
              <label>PNG: Escala (1 a 4)</label>
              <input id="sEnvPngScale" type="number" min="1" max="4" step="1" placeholder="Ej: 2"/>
            </div>

            <div class="field">
              <label>PDF: Ancho papel (mm)</label>
              <input id="sEnvPdfWidth" type="number" min="50" max="120" step="1" placeholder="Ej: 80"/>
            </div>

            <div class="field">
              <label>PDF: Margen (mm)</label>
              <input id="sEnvPdfMargin" type="number" min="0" max="20" step="1" placeholder="Ej: 6"/>
            </div>

            <div class="field full">
              <button class="btn primary" id="btnSaveSettings">Guardar</button>
            </div>
          </div>

          <div class="muted" style="margin-top:10px">
            Nota: todo se guarda en tu navegador. Si cambias de PC/navegador, exporta e importa el JSON.
          </div>
        </div>
      </section>

      <input type="file" id="restoreFile" accept="application/json" class="hide"/>
      <canvas id="cnv" class="hide"></canvas>
    </main>
  </div>

  <!-- html2canvas (mejora PNG) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>

/* ============================================================
   POS Boutique Offline (IndexedDB)
   - Mantiene dise√±o y funciones originales
   - + Inventarios en men√∫
   - + Descuentos (Q/%)
   - + Cierres m√∫ltiples por d√≠a + cuadre por forma de pago
   - + Env√≠os pendientes: PENDIENTE/PAGADO (solo PAGADO pasa a ventas)
   - + Tama√±os PNG/PDF configurables SOLO para ENV√çO (con c√≥digo 363534)
============================================================ */

const DB_NAME = "pos_boutique_offline_v1";
const DB_VER = 8; // bumped for movements+kardex // subimos versi√≥n
let db;
let appReady = false; // evita clicks antes de que IndexedDB est√© lista

// ============================================================
// Logo seguro para exportaci√≥n PNG (evita "Tainted canvas")
// - Intenta inline (DataURL) desde localStorage o LOGO1.png
// - Si no puede (por ejemplo file://), pide al usuario cargar el logo 1 vez
// ============================================================
const LOGO_DATAURL_KEY = "MB_LOGO_DATAURL_V1";

async function fileToDataURL(file){
  return await new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(r.result);
    r.onerror = ()=>reject(new Error("No se pudo leer el archivo."));
    r.readAsDataURL(file);
  });
}

async function promptLogoUpload(){
  return await new Promise((resolve)=>{
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "image/*";
    inp.style.position = "fixed";
    inp.style.left = "-99999px";
    document.body.appendChild(inp);
    inp.addEventListener("change", async ()=>{
      try{
        const f = inp.files && inp.files[0];
        if(!f){ resolve(null); return; }
        const data = await fileToDataURL(f);
        localStorage.setItem(LOGO_DATAURL_KEY, data);
        resolve(data);
      }catch(e){
        resolve(null);
      }finally{
        inp.remove();
      }
    }, {once:true});
    inp.click();
  });
}

async function getInlineLogoDataURL(){
  let data = localStorage.getItem(LOGO_DATAURL_KEY);
  if(data) return data;

  // intento 1: fetch LOGO1.png (funciona bien en http/https)
  try{
    const resp = await fetch("LOGO1.png", {cache:"no-store"});
    if(resp && resp.ok){
      const blob = await resp.blob();
      data = await fileToDataURL(blob);
      localStorage.setItem(LOGO_DATAURL_KEY, data);
      return data;
    }
  }catch(e){ /* ignore */ }

  // intento 2: en file:// o si fall√≥ fetch, pedimos al usuario seleccionar el logo
  return null;
}

async function ensureLogosSafe(root){
  if(!root) return;
  // set crossOrigin siempre
  root.querySelectorAll("img").forEach(img=>{ try{ img.crossOrigin = "anonymous"; }catch(e){} });

  const data = await getInlineLogoDataURL();
  if(!data) return;

  root.querySelectorAll("img").forEach(img=>{
    const src = (img.getAttribute("src")||"").trim();
    if(src === "LOGO1.png" || src.endsWith("/LOGO1.png") || src.includes("LOGO1.png")){
      img.setAttribute("src", data);
    }
  });
}

async function ensureLogoOrAsk(node){
  if(!node) return;
  // 1) intenta sanear (fetch->DataURL) y reemplazar
  await ensureLogosSafe(node);

  // 2) espera a que carguen im√°genes
  await new Promise(r=>setTimeout(r, 60));

  // 3) si el logo sigue sin cargar, pedimos cargarlo 1 vez
  const imgs = Array.from(node.querySelectorAll("img"));
  const logoImgs = imgs.filter(img=>{
    const src = (img.getAttribute("src")||"").trim();
    return src.includes("LOGO1") || src.startsWith("data:image/");
  });

  // Si hay al menos una imagen y ninguna carg√≥, forzamos selecci√≥n
  const anyBad = logoImgs.length && logoImgs.every(img=> !(img.naturalWidth > 0));
  if(anyBad){
    const picked = await promptLogoUpload();
    if(picked){
      await ensureLogosSafe(node);
      await new Promise(r=>setTimeout(r, 60));
    }
  }
}



const state = {
  view: "pos",
  cart: [],
  selectedClient: null,
  lastReceipt: null,  // puede ser venta o env√≠o (pending/paid)
  lastClose: null,
  discount: { type:"Q", value:0 },
  settings: {
    shopName: "Tienda de Ropa",
    autoPDF:true,
    autoPNG:true,
    envPngWidth: 360,
    envPngScale: 2,
    envPdfWidthMM: 80,
    envPdfMarginMM: 6
  }
};
state.backup = {
  dirHandle: null,
  enabled: true
};
const $ = (id)=>document.getElementById(id);
// Sincroniza UI de descuentos con el estado actual
function syncDiscUI(){
  const d = state.discount || {type:"NONE", value:0};
  const typeEl = $("discType");
  const valEl  = $("discValue");
  if(typeEl) typeEl.value = d.type || "NONE";

  // Si no hay descuento, dejamos vac√≠o para que no moleste
  if(valEl){
    if(!d.type || d.type==="NONE") valEl.value = "";
    else valEl.value = String(d.value ?? 0);
    valEl.disabled = (!d.type || d.type==="NONE");
  }
}

const money = (n)=> "Q" + (Number(n||0)).toFixed(2);
// ---------- Cart math + UI ----------
function calcSubtotal(){
  return (state.cart||[]).reduce((sum,it)=> sum + (Number(it.price||0) * Number(it.qty||0)), 0);
}
function calcDiscount(){
  const sub = calcSubtotal();
  const d = state.discount || { type:"NONE", value:0 };
  if(d.type === "Q"){
    const v = Math.max(0, Number(d.value||0));
    return Math.min(sub, v);
  }
  if(d.type === "PCT"){
    const p = Math.max(0, Number(d.value||0));
    return sub * (p/100);
  }
  return 0;
}
function calcGrand(){
  return Math.max(0, calcSubtotal() - calcDiscount());
}
// -------- Compat helpers (evita errores por funciones renombradas) --------
function cartSubtotal(){ return calcSubtotal(); }
function cartDiscountAmount(){ return calcDiscount(); }
function cartTotal(){ return calcGrand(); }
// Alias usado por paneles antiguos
const idbGetAll = idbAll;

function renderCart(){
  const tbody = $("cartBody");
  if(!tbody) return;

  const cart = state.cart || [];
  if(!cart.length){
    tbody.innerHTML = `<tr><td colspan="5" class="muted">Carrito vac√≠o</td></tr>`;
  }else{
    tbody.innerHTML = cart.map(it=>{
      const qty = Number(it.qty||0);
      const price = Number(it.price||0);
      const line = qty * price;
      const code = String(it.code||"");
      const name = String(it.name||"");
      return `
        <tr>
          <td class="qty">
            <button class="mini" data-act="minus" data-code="${code}">‚àí</button>
            <span class="q">${qty}</span>
            <button class="mini" data-act="plus" data-code="${code}">+</button>
          </td>
          <td class="name">
            <div class="t">${name}</div>
            <div class="s muted">${code}</div>
          </td>
          <td class="price">${money(price)}</td>
          <td class="line">${money(line)}</td>
          <td class="act">
            <button class="mini danger" data-act="del" data-code="${code}">‚úï</button>
          </td>
        </tr>`;
    }).join("");
  }

  // Totales
  const subEl = $("subTotal"); if(subEl) subEl.textContent = money(calcSubtotal());
  const discEl = $("discTotal"); if(discEl) discEl.textContent = money(calcDiscount());
  const grandEl = $("grandTotal"); if(grandEl) grandEl.textContent = money(calcGrand());

  // Refresca recibo / previsualizaci√≥n
  if(typeof updateReceiptPreview === "function") updateReceiptPreview();
}

// ---------- IndexedDB ----------
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;

      if(!db.objectStoreNames.contains("clients")){
        const s = db.createObjectStore("clients", { keyPath:"phone" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("products")){
        const s = db.createObjectStore("products", { keyPath:"code" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("sales")){
        const s = db.createObjectStore("sales", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
      }
      // NUEVO: shipments (env√≠os pendientes)
      if(!db.objectStoreNames.contains("shipments")){
        const s = db.createObjectStore("shipments", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("status", "status", { unique:false });
      }
      // NUEVO: closes (cierres guardados)
      if(!db.objectStoreNames.contains("closes")){
        const s = db.createObjectStore("closes", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("dateKey", "dateKey", { unique:false });
      }

      
      // NUEVO: movements (kardex perpetuo)
      if(!db.objectStoreNames.contains("movements")){
        const s = db.createObjectStore("movements", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("code", "code", { unique:false });
      }

if(!db.objectStoreNames.contains("meta")){
        db.createObjectStore("meta", { keyPath:"key" });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}

function tx(store, mode="readonly"){
  if(!db){
    throw new Error("DB no est√° lista todav√≠a (db undefined). Recarga la p√°gina y espera 1-2 segundos.");
  }
  return db.transaction(store, mode).objectStore(store);
}
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store).get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(store, val){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").put(val);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbDel(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").delete(key);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbAll(store){
  return new Promise((res,rej)=>{
    const r = tx(store).getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbClearAll(){
  return Promise.all([
    new Promise((res,rej)=>{ const r=db.transaction("clients","readwrite").objectStore("clients").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("products","readwrite").objectStore("products").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("sales","readwrite").objectStore("sales").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("shipments","readwrite").objectStore("shipments").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("closes","readwrite").objectStore("closes").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("meta","readwrite").objectStore("meta").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
  ]);
}


// ---------- Movements (Kardex) ----------
function mkMoveId(){
  return `${Date.now()}-${Math.random().toString(16).slice(2)}`;
}
async function logMovement(mv){
  // mv: {type, code, name, qty, stockAfter, refType, refId, note}
  const row = {
    id: mkMoveId(),
    ts: Date.now(),
    type: mv.type || "MOV",
    code: mv.code || "",
    name: mv.name || "",
    qty: Number(mv.qty||0),
    stockAfter: (mv.stockAfter===undefined? null : Number(mv.stockAfter)),
    refType: mv.refType || "",
    refId: mv.refId || "",
    note: mv.note || ""
  };
  await idbPut("movements", row);
}
async function getShiftStartTs(){
  const m = await idbGet("meta","shiftStartTs");
  return m?.value ? Number(m.value) : null;
}

async function setShiftStartTs(ts){
  await idbPut("meta", { key:"shiftStartTs", value: Number(ts||Date.now()) });
}
async function clearPaidShipments(){
  const all = await idbAll("shipments");
  const paid = all.filter(s => (s.status||"PENDIENTE")==="PAGADO" && (s.saleId || s.paidAt));
  for(const s of paid){
    await idbDel("shipments", s.id);
  }
  return true;
}
async function clearAllShipments(){
  // borra SOLO shipments
  return new Promise((res, rej)=>{
    const r = db.transaction("shipments","readwrite").objectStore("shipments").clear();
    r.onsuccess = ()=>res(true);
    r.onerror = ()=>rej(r.error);
  });
}
function toLocalTs(dateStr, timeStr){
  const d = String(dateStr||"").trim();
  const t = String(timeStr||"00:00").trim();
  if(!d) return null;
  // "YYYY-MM-DDTHH:MM" en local
  const dt = new Date(`${d}T${t}:00`);
  const ts = dt.getTime();
  return Number.isFinite(ts) ? ts : null;
}

async function renderReportRange(){
  const all = await idbAll("sales");

  const fd = $("repFromDate")?.value || todayKey();
  const ft = $("repFromTime")?.value || "00:00";
  const td = $("repToDate")?.value || fd;
  const tt = $("repToTime")?.value || "23:59";

  const a = toLocalTs(fd, ft);
  const b = toLocalTs(td, tt);
  if(a===null || b===null) return alert("Rango inv√°lido. Revisa fechas/horas.");

  const start = Math.min(a,b);
  const end   = Math.max(a,b);

  const list = all.filter(s => {
    const ts = Number(s.ts||0);
    return ts >= start && ts <= end;
  });

  const total = list.reduce((sum,s)=> sum + Number(s.total||0), 0);
  $("repCount").textContent = list.length;
  $("repTotal").textContent = money(total);

  const tb = $("salesBody");
  tb.innerHTML = "";
  for(const s of list.sort((x,y)=>Number(y.ts||0)-Number(x.ts||0))){
    const when = new Date(s.ts).toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total)}</td>
      <td>
        <button class="btn small" data-viewsale="${escapeHtml(s.id)}">Ver</button>
        <button class="btn danger small" data-delsale="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}



// ---------- Helpers ----------
function todayKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function weekKey(ts=Date.now()){
  const d = new Date(ts);
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = tmp.getUTCDay() || 7;
  tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
  return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}
function monthKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normKey(s){
  return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
}
function pad(n,len=6){ return String(n).padStart(len,"0"); }
function timeToMinutes(hhmm){
  const [h,m] = String(hhmm||"00:00").split(":").map(x=>Number(x||0));
  return (h*60)+(m||0);
}
function isWithinDateRange(ts, dateKey, fromHHMM, toHHMM){
  const d = new Date(ts);
  const dk = todayKey(ts);
  if(dk !== dateKey) return false;
  const mins = d.getHours()*60 + d.getMinutes();
  const a = timeToMinutes(fromHHMM);
  const b = timeToMinutes(toHHMM);
  // rango normal (no cruzando medianoche)
  return mins >= a && mins <= b;
}
async function clearStore(store){
  return new Promise((res, rej)=>{
    const tx = db.transaction(store, "readwrite");
    const os = tx.objectStore(store);
    const r = os.clear();

    r.onsuccess = () => res(true);
    r.onerror   = () => rej(r.error);
  });
}

// ---------- UI Nav ----------
const views = {
  pos: {title:"Registro de Ventas)", sub:""},
  shipments: {title:"Env√≠os pendientes", sub:"Gesti√≥n de env√≠os: PENDIENTE/PAGADO."},
  kardex: {title:"Kardex", sub:"Movimientos perpetuos de inventario (entradas y salidas)."},
  clients: {title:"Clientes", sub:"Busca por tel√©fono, edita y usa para env√≠os."},
  reports: {title:"Reportes", sub:"Diario / Semanal / Mensual con historial de ventas (solo pagadas)."},
  products: {title:"Productos", sub:"Agrega productos con c√≥digo, nombre, precio y stock."},
  inventory: {title:"Inventarios", sub:"Tabla de productos + stock actual."},
  close: {title:"Cierres", sub:"Cierres m√∫ltiples + cuadre por forma de pago."},
  settings: {title:"Ajustes", sub:"Nombre de tienda, tama√±os ENV√çO y respaldos (exportar/importar)."}
};

function setView(v){
  // Robust: evita crasheos si llega un data-view inexistente
  if(!v || !views[v]){
    console.warn("Vista desconocida:", v);
    return;
  }

  state.view = v;

  const tEl = $("viewTitle");
  const sEl = $("viewSub");
  if(tEl) tEl.textContent = views[v].title || "";
  if(sEl) sEl.textContent = views[v].sub || "";

  // Mostrar/ocultar vistas solo si existen en el DOM
  for(const k in views){
    const el = $("view-"+k);
    if(el) el.classList.toggle("hide", k !== v);
  }

  // Acciones al entrar en ciertas vistas
  if(v==="kardex"){ renderKardex(); }
  if(v==="shipments"){ renderShipments(); }
  if(v==="products"){ renderProducts(); }
  if(v==="clients"){ renderClients(); }
  if(v==="inventory"){ renderInventory(); }

  // ‚úÖ AQU√ç el cambio
  if(v==="reports"){
    const t = todayKey();

    if($("repFromDate")) $("repFromDate").value = t;
    if($("repToDate"))   $("repToDate").value   = t;

    if($("repFromTime")) $("repFromTime").value = "00:00";
    if($("repToTime"))   $("repToTime").value   = "23:59";

    renderReports();
  }

  if(v==="close"){ renderClosePanel(); }

  // POS Totales
  if(v==="pos"){
    const subtotal = calcSubtotal();
    const disc = calcDiscount();
    const total = Math.max(0, subtotal - disc);

    const st = $("subTotal");
    const dt = $("discTotal");
    const gt = $("grandTotal");
    if(st) st.textContent = money(subtotal);
    if(dt) dt.textContent = money(disc);
    if(gt) gt.textContent = money(total);

    updateReceiptPreview();
  }
}

function cartAdd(product, qty=1){
  qty = Number(qty||1);
  if(qty<1) qty=1;
  const found = state.cart.find(x=>x.code===product.code);
  if(found) found.qty += qty;
  else state.cart.push({code:product.code, name:product.name, price:Number(product.price), qty});
  renderCart();
}

function cartInc(code, delta){
  const it = state.cart.find(x=>x.code===code);
  if(!it) return;
  it.qty += delta;
  if(it.qty<=0) state.cart = state.cart.filter(x=>x.code!==code);
  renderCart();
}

function cartClear(){
  state.cart = [];
  renderCart();
}

// ---------- Clients ----------
async function findClientByPhone(phone){
  phone = String(phone||"").trim();
  if(!phone) return null;
  return await idbGet("clients", phone);
}

async function saveClientFromForm(){
  const phone = $("cPhone").value.trim();
  const names = $("cNames").value.trim();
  const last  = $("cLast").value.trim();
  const addr  = $("cAddr").value.trim();
  const indic = $("cIndic").value.trim();

  if(!phone) return alert("Ingrese tel√©fono.");
  if(!names || !last || !addr) return alert("Complete Nombres, Apellidos y Direcci√≥n.");

  const client = {
    phone,
    names, last, addr, indic,
    nameKey: normKey(names+" "+last),
    updatedAt: Date.now()
  };
  await idbPut("clients", client);
  state.selectedClient = client;
  alert("Cliente guardado.");
  await refreshKPIs();
  if(state.view==="clients") renderClients();
  updateReceiptPreview();
}

async function renderClients(){
  const q = normKey($("clientSearch").value);
  const all = await idbAll("clients");
  const list = q ? all.filter(c => normKey(c.phone).includes(q) || (c.nameKey||"").includes(q) || normKey(c.addr).includes(q)) : all;

  const tb = $("clientsBody");
  tb.innerHTML = "";
  for(const c of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(c.phone)}</td>
      <td>${escapeHtml(c.names)} ${escapeHtml(c.last)}</td>
      <td><small>${escapeHtml(c.addr)}</small></td>
      <td>
        <button class="btn small" data-useclient="${escapeHtml(c.phone)}">Usar</button>
        <button class="btn danger small" data-delclient="${escapeHtml(c.phone)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Products ----------
async function saveProductFromForm(){
  const code = $("pCode").value.trim();
  const name = $("pName").value.trim();
  const price = Number($("pPrice").value);
  const stock = Number($("pStock").value);

  if(!code) return alert("Ingrese C√≥digo (SKU/barras).");
  if(!name) return alert("Ingrese Nombre.");
  if(isNaN(price) || price<0) return alert("Precio inv√°lido.");
  if(isNaN(stock) || stock<0) return alert("Stock inv√°lido.");

  const exists = await idbGet("products", code);
  if(exists){
    if(!requireCode("editar producto")) return;
  }

  const product = {
    code, name,
    price, stock,
    nameKey: normKey(name),
    updatedAt: Date.now()
  };
  await idbPut("products", product);
  // Kardex: registra cambio de stock (ingreso/ajuste)
  {
    const prev = exists ? Number(exists.stock||0) : 0;
    const delta = Number(stock) - prev;
    if(delta !== 0){
      await logMovement({
        type: (delta>0 ? "INGRESO" : "AJUSTE"),
        code, name,
        qty: delta,
        stockAfter: stock,
        refType: "PRODUCTO",
        refId: code,
        note: exists ? "Edici√≥n de stock" : "Alta de producto"
      });
    }
  }
  alert("Producto guardado.");
  $("pCode").value=""; $("pName").value=""; $("pPrice").value=""; $("pStock").value="";
  await refreshKPIs();
  renderProducts();
  refreshProductPicker();
}

async function getProductByCode(code){
  return await idbGet("products", code);
}

async function renderProducts(){
  const q = normKey($("prodSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("productsBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${Number(p.stock||0)}</td>
      <td>
        <button class="btn small" data-fillprod="${escapeHtml(p.code)}">Editar</button>
        <button class="btn danger small" data-delprod="${escapeHtml(p.code)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function refreshProductPicker(){
  const q = normKey($("productSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p=> (p.nameKey||"").includes(q) || normKey(p.code).includes(q)) : all;

  const sel = $("productPicker");
  sel.innerHTML = "";
  if(list.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay productos (agrega en Productos)";
    sel.appendChild(opt);
    return;
  }
  for(const p of list.slice(0,300)){
    const opt = document.createElement("option");
    opt.value = p.code;
    opt.textContent = `${p.name} ‚Äî ${p.code} ‚Äî ${money(p.price)} ‚Äî Stock:${p.stock}`;
    sel.appendChild(opt);
  }
}

// ---------- Inventory ----------
async function renderInventory(){
  const q = normKey($("invSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("invBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${Number(p.stock||0)}</td>
    `;
    tb.appendChild(tr);
  }
}


// ---------- Kardex UI ----------
async function renderKardex(){
  const q = ($("kSearch")?.value || "").trim().toLowerCase();
  const t = ($("kType")?.value || "").trim();

  let rows = await idbGetAll("movements");
  rows.sort((a,b)=>(b.ts||0)-(a.ts||0));

  if(t) rows = rows.filter(r=>String(r.type||"")===t);
  if(q){
    rows = rows.filter(r=>{
      const code = String(r.code||"").toLowerCase();
      const name = String(r.name||"").toLowerCase();
      const note = String(r.note||"").toLowerCase();
      return code.includes(q) || name.includes(q) || note.includes(q);
    });
  }

  const body = $("kBody");
  if(!body) return;
  body.innerHTML = rows.map(r=>{
    const dt = new Date(r.ts||0);
    const f = dt.toLocaleString("es-GT");
    const qty = Number(r.qty||0);
    const qtyTxt = (qty>0? `+${qty}` : String(qty));
    const stockTxt = (r.stockAfter===null || r.stockAfter===undefined) ? "" : String(r.stockAfter);
    const ref = [r.refType, r.refId].filter(Boolean).join(": ");
    return `
      <tr>
        <td>${escapeHtml(f)}</td>
        <td><b>${escapeHtml(String(r.type||""))}</b></td>
        <td>${escapeHtml(String(r.code||""))}</td>
        <td>${escapeHtml(String(r.name||""))}</td>
        <td style="text-align:right">${escapeHtml(qtyTxt)}</td>
        <td style="text-align:right">${escapeHtml(stockTxt)}</td>
        <td>${escapeHtml(ref)}</td>
        <td>${escapeHtml(String(r.note||""))}</td>
      </tr>
    `;
  }).join("");
}

async function clearKardex(){
  if(!confirm("¬øSeguro? Esto borrar√° TODOS los movimientos del kardex.")) return;
  await clearStore("movements");
  await renderKardex();
}



// ---------- Sales / Shipments / Checkout ----------
async function nextReceiptNo(){
  const meta = await idbGet("meta","receiptNo");
  const n = meta?.value ? Number(meta.value) : 1;
  await idbPut("meta",{key:"receiptNo", value:n+1});
  return n;
}

function requireClientIfShipping(){
  const type = $("saleType").value;
  if(type==="ENVIO"){
    const c = state.selectedClient;
    if(!c || !c.phone || !c.names || !c.last || !c.addr){
      return {ok:false, msg:"En ENV√çO es obligatorio seleccionar/crear un cliente con tel√©fono, nombre y direcci√≥n."};
    }
  }
  return {ok:true};
}

async function validateStockForCart(){
  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    if(!p) return {ok:false, msg:"Producto no existe: " + it.code};
    if(Number(p.stock||0) < it.qty) return {ok:false, msg:`Stock insuficiente para "${p.name}". Stock:${p.stock} Cant:${it.qty}`};
  }
  return {ok:true};
}

async function deductStockForCart(refType="VENTA", refId="", note=""){
  for(const it of state.cart){
    const p = await getProductByCode(it.code);
    p.stock = Number(p.stock||0) - it.qty;
    p.updatedAt = Date.now();
    await idbPut("products", p);
    // Kardex: salida por venta/env√≠o
    await logMovement({
      type: "SALIDA",
      code: it.code,
      name: p.name || it.name || "",
      qty: -Number(it.qty||0),
      stockAfter: p.stock,
      refType: refType,
      refId: refId,
      note: note || (refType==="ENVIO" ? "Env√≠o" : "Venta")
    });
  }
}

async function restoreStockForItems(items, refType="", refId="", note=""){
  for(const it of (items||[])){
    const p = await getProductByCode(it.code);
    if(!p) continue;
    p.stock = Number(p.stock||0) + Number(it.qty||0);
    p.updatedAt = Date.now();
    await idbPut("products", p);
    // Kardex: entrada por devoluci√≥n/anulaci√≥n
    await logMovement({
      type: "ENTRADA",
      code: it.code,
      name: p.name || it.name || "",
      qty: Number(it.qty||0),
      stockAfter: p.stock,
      refType: refType,
      refId: refId,
      note: note || "Restock"
    });
  }
}

async function checkout(){
  if(state.cart.length===0) return alert("No hay productos en la venta.");
  const clientRule = requireClientIfShipping();
  if(!clientRule.ok) return alert(clientRule.msg);

  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;

  const subtotal = cartSubtotal();
  const discountAmount = cartDiscountAmount(subtotal);
  const total = Math.max(subtotal - discountAmount, 0);

  const ts = Date.now();
  const id = "S-" + ts + "-" + Math.random().toString(16).slice(2,8);
  const receiptNo = await nextReceiptNo();

  // Validar stock siempre (MOSTRADOR y ENV√çO)
  const st = await validateStockForCart();
  if(!st.ok) return alert(st.msg);

  // Opci√≥n A: ENVI√ì descuenta stock al crear el env√≠o pendiente (lo que t√∫ elegiste).
  await deductStockForCart(saleType, receiptNo, "Venta");

  const client = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);

  if(saleType === "ENVIO"){
    // Crear ENV√çO pendiente (no entra a ventas/reporte/cierre hasta que se marque PAGADO)
    const shipment = {
      id: "E-" + ts + "-" + Math.random().toString(16).slice(2,8),
      ts,
      dateKey: todayKey(ts),
      weekKey: weekKey(ts),
      monthKey: monthKey(ts),
      saleType, payMethod,
      status: "PENDIENTE",
      client: client ? { phone:client.phone, names:client.names, last:client.last, addr:client.addr, indic:client.indic } : null,
      items: state.cart.map(x=>({...x})),
      subtotal: Number(subtotal.toFixed(2)),
      discountType: state.discount.type,
      discountValue: Number(state.discount.value||0),
      discountAmount: Number(discountAmount.toFixed(2)),
      total: Number(total.toFixed(2)),
      receiptNo: pad(receiptNo, 6),
      shop: state.settings.shopName || "Tienda de Ropa",
      stockDeducted: true,
      paidAt: null,
      saleId: null
    };

    await idbPut("shipments", shipment);
    state.lastReceipt = shipment;
 await autoBackupToFolder("envio_pendiente");

    // reset carrito + descuento
    state.discount = {type:"NONE", value:0};
    syncDiscUI();
    cartClear();

    // limpiar UI + KPIs
    await refreshKPIs();
    refreshProductPicker();
    if(state.view==="inventory") renderInventory();
    updateReceiptPreview();
    if(state.view==="shipments") renderShipments();

    // Auto descargas SOLO si quieres (respetamos tu setting auto)
    // Nota: aunque sea pendiente, puedes generar comprobante para el cliente; NO cuenta como venta.
    if(state.settings.autoPDF) setTimeout(()=>{ try{ generatePDF(); }catch(e){} }, 200);
    if(state.settings.autoPNG) setTimeout(()=>{ try{ downloadReceiptPNG(); }catch(e){} }, 700);

    alert("Env√≠o creado como PENDIENTE. En 'Env√≠os pendientes' puedes marcarlo como PAGADO para que cuente como venta.");
    return;
  }

  // MOSTRADOR: s√≠ es venta directa
  const sale = {
    id, ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType, payMethod,
    client: client ? { phone:client.phone, names:client.names, last:client.last, addr:client.addr } : null,
    items: state.cart.map(x=>({...x})),
    subtotal: Number(subtotal.toFixed(2)),
    discountType: state.discount.type,
    discountValue: Number(state.discount.value||0),
    discountAmount: Number(discountAmount.toFixed(2)),
    total: Number(total.toFixed(2)),
    receiptNo: pad(receiptNo, 6),
    shop: state.settings.shopName || "Tienda de Ropa",
    source: "DIRECT"
  };

  await idbPut("sales", sale);
  state.lastReceipt = sale;
  await autoBackupToFolder("venta");

  // reset carrito + descuento
  state.discount = {type:"NONE", value:0};
  syncDiscUI();

  cartClear();
  await refreshKPIs();
  refreshProductPicker();
  if(state.view==="inventory") renderInventory();
  updateReceiptPreview();

  // Auto descargas
 // Auto descargas (solo para MOSTRADOR, no para ENV√çOS)
if(sale.saleType !== "ENVIO"){
  if(state.settings.autoPDF) setTimeout(()=>{
    try{ generatePDF(); }catch(e){}
  }, 200);

  if(state.settings.autoPNG) setTimeout(()=>{
    try{ downloadReceiptPNG(); }catch(e){}
  }, 700);
}


  alert("Venta registrada. Recibo listo para WhatsApp/PDF/PNG.");
}

// ---------- Shipments ----------
function shipmentClientName(s){
  return s.client ? `${s.client.names} ${s.client.last}` : "‚Äî";
}
function shipmentSearchKey(s){
  return normKey(`${s.receiptNo||""} ${s.client?.phone||""} ${shipmentClientName(s)} ${s.client?.addr||""}`);
}
async function renderShipments(){
  const q = normKey($("shipSearch").value);
  const f = $("shipFilter").value || "ALL";
  const all = await idbAll("shipments");

  let list = all;
  if(f !== "ALL") list = list.filter(s => (s.status||"PENDIENTE") === f);
  if(q) list = list.filter(s => shipmentSearchKey(s).includes(q));

  list.sort((a,b)=>b.ts-a.ts);

  const tb = $("shipBody");
  tb.innerHTML = "";

  for(const s of list){
    const d = new Date(s.ts).toLocaleString();
    const tr = document.createElement("tr");
    const status = s.status || "PENDIENTE";
    const statusHtml = status==="PAGADO"
      ? `<span style="font-weight:1000;color:#0e5b2a">‚úÖ PAGADO</span>`
      : `<span style="font-weight:1000;color:#7a4b00">‚è≥ PENDIENTE</span>`;

    tr.innerHTML = `
      <td><small>${escapeHtml(d)}</small></td>
      <td><b>#${escapeHtml(s.receiptNo||"")}</b></td>
      <td>${escapeHtml(shipmentClientName(s))}<br><small>${escapeHtml(s.client?.phone||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
      <td>${statusHtml}</td>
      <td>
        <button class="btn small" data-viewship="${escapeHtml(s.id)}">Ver</button>
        <button class="btn ok small" data-payship="${escapeHtml(s.id)}">Marcar PAGADO</button>
        <button class="btn danger small" data-delship="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function markShipmentPaid(id){
  const s = await idbGet("shipments", id);
  if(!s) return alert("Env√≠o no encontrado.");
  if((s.status||"PENDIENTE")==="PAGADO"){
    alert("Ya est√° PAGADO.");
    return;
  }

  // Crear venta desde el env√≠o (NO tocar stock, ya se descont√≥ en creaci√≥n)
  const ts = Date.now();
  const saleId = "S-" + ts + "-" + Math.random().toString(16).slice(2,8);

  const sale = {
    id: saleId,
    ts: ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType: "ENVIO",
    payMethod: s.payMethod,
    client: s.client || null,
    items: (s.items||[]).map(x=>({...x})),
    subtotal: Number((s.subtotal ?? s.total ?? 0).toFixed(2)),
    discountType: s.discountType || "NONE",
    discountValue: Number(s.discountValue||0),
    discountAmount: Number((s.discountAmount ?? 0).toFixed(2)),
    total: Number((s.total ?? 0).toFixed(2)),
    receiptNo: s.receiptNo,
    shop: s.shop || state.settings.shopName || "Tienda de Ropa",
    source: "SHIPMENT",
    shipmentId: s.id,
    paidAt: ts
  };

  await idbPut("sales", sale);
await autoBackupToFolder("envio_pagado");

  // Actualizar env√≠o a PAGADO (mantener, para historial)
  s.status = "PAGADO";
  s.paidAt = ts;
  s.saleId = saleId;
  await idbPut("shipments", s);

  state.lastReceipt = sale;
  await refreshKPIs();
  if(state.view==="shipments") renderShipments();
  if(state.view==="reports") renderReport("daily");
  updateReceiptPreview();
  buildClose();

  alert("Env√≠o marcado como PAGADO. Ya cuenta como venta en Reportes y Cierres.");
}

// (removido) bot√≥n pendiente eliminado


async function deleteShipment(id){
  if(!requireCode("borrar env√≠o")) return;
  const s = await idbGet("shipments", id);
  if(!s) return;
  if(!confirm("¬øBorrar env√≠o #"+(s.receiptNo||"") + "?")) return;

  // Si era pendiente (o incluso pagado), restauramos stock SOLO si fue descontado y todav√≠a est√° en shipments.
  // Nota: Si ya se vendi√≥ (saleId), normalmente NO se deber√≠a restaurar porque la venta existe. Lo protegemos:
  if(s.stockDeducted && !s.saleId){
    await restoreStockForItems(s.items||[]);
  }

  await idbDel("shipments", id);
  await refreshKPIs();
  renderShipments();
  renderInventory();
  refreshProductPicker();
  alert("Env√≠o borrado.");
}

// ---------- Reports ----------
async function renderReport(mode){
  const all = await idbAll("sales");
  const now = Date.now();
  let list = [];

  if(mode==="daily"){
    const k = todayKey(now);
    list = all.filter(s=>s.dateKey===k);
  }else if(mode==="weekly"){
    const k = weekKey(now);
    list = all.filter(s=>s.weekKey===k);
  }else{
    const k = monthKey(now);
    list = all.filter(s=>s.monthKey===k);
  }

  const total = list.reduce((a,s)=>a+Number(s.total||0),0);
  $("repCount").textContent = list.length;
  $("repTotal").textContent = money(total);

  const tb = $("salesBody");
  tb.innerHTML = "";
  for(const s of list.sort((a,b)=>b.ts-a.ts)){
    const d = new Date(s.ts);
    const when = d.toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total)}</td>
      <td>
        <button class="btn small" data-viewsale="${escapeHtml(s.id)}">Ver</button>
        <button class="btn danger small" data-delsale="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Receipt (text + preview + PDF + PNG) ----------
function applyEnvReceiptSizing(saleType){
  const node = $("receiptBox");
  if(!node) return;

  // Clase para estilos ENV√çO (autoajuste / tipograf√≠a)
  node.classList.toggle("envio", saleType === "ENVIO");

  // Solo ENV√çO aplica tama√±o configurable
  if(saleType === "ENVIO"){
    const w = Number(state.settings.envPngWidth || 360);
    node.style.width = Math.max(260, Math.min(520, w)) + "px";
  }else{
    node.style.width = ""; // vuelve a CSS default
  }
}

function makeLiveReceipt(){
  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;
  const c = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);
  return {
    ts: Date.now(),
    receiptNo: state.lastReceipt?.receiptNo || String($("rNo").textContent||"").replace("#","") || "------",
    shop: state.settings.shopName,
    saleType, payMethod,
    status: (saleType==="ENVIO") ? "PENDIENTE" : "PAGADO",
    client: c ? {phone:c.phone, names:c.names, last:c.last, addr:c.addr, indic:c.indic} : null,
    items: state.cart.map(x=>({...x})),
    subtotal: cartSubtotal(),
    discountAmount: cartDiscountAmount(cartSubtotal()),
    total: cartTotal()
  };
}

function saleToReceiptText(s){
  if(!s) return "No hay recibo todav√≠a.";
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr || "‚Äî";
  const status = s.status ? `Estatus: ${s.status}` : "";
  const lines = [];
  lines.push(`üßæ *${s.shop}*`);
  lines.push(`Recibo #${s.receiptNo}`);
  lines.push(`Fecha: ${d}`);
  if(status) lines.push(status);
  lines.push(`Tipo: ${s.saleType} | Pago: ${s.payMethod}`);
  lines.push(`Cliente: ${client}`);
  lines.push(`Tel: ${phone}`);
  lines.push(`Dir: ${addr}`);
  lines.push(`--------------------------------`);
  for(const it of (s.items||[])){
    lines.push(`${it.qty} x ${it.name} = ${money(it.qty*it.price)}`);
  }
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(s.subtotal ?? s.total)}`);
  lines.push(`DESCUENTO: ${money(s.discountAmount ?? 0)}`);
  lines.push(`TOTAL: *${money(s.total)}*`);
  lines.push(`Gracias por tu compra üíó`);
  return lines.join("\n"); // <- SALTOS REALES
}

function updateReceiptPreview(){
  const s = state.lastReceipt || makeLiveReceipt();
  const saleType = s.saleType || $("saleType").value;

  applyEnvReceiptSizing(saleType);

  $("rShop").textContent = s.shop || state.settings.shopName || "Tienda de Ropa";
  $("rMeta").textContent = `Recibo ‚Ä¢ ${s.saleType || "MOSTRADOR"} ‚Ä¢ ${s.payMethod || "EFECTIVO"}`;
  $("rNo").textContent = "#" + (s.receiptNo || "------");
  $("rDate").textContent = new Date(s.ts || Date.now()).toLocaleString();

  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  $("rClient").textContent = client;
  $("rPhone").textContent = s.client?.phone || "‚Äî";
  $("rAddr").textContent  = s.client?.addr || "‚Äî";
  $("rPay").textContent   = s.payMethod || $("payMethod").value;

  const badge = $("rStatusBadge");
  const status = s.status || (saleType==="ENVIO" ? "PENDIENTE" : "PAGADO");
  badge.classList.remove("hide","pending","paid");
  if(status === "PENDIENTE"){
    badge.textContent = "‚è≥ PENDIENTE";
    badge.classList.add("pending");
  }else{
    badge.textContent = "‚úÖ PAGADO";
    badge.classList.add("paid");
  }

  // Indicaciones (cliente)
  $("rIndic").textContent = s.client?.indic || "‚Äî";

  const itemsDiv = $("rItems");
  itemsDiv.innerHTML = "";

  const isEnvio = (saleType === "ENVIO");
  const pay = (s.payMethod || $("payMethod").value || "EFECTIVO");

  // En ENV√çO: NO mostramos detalle de productos.
  // - Si es EFECTIVO: mostramos SOLO el TOTAL.
  // - Si es TARJETA/TRANSFERENCIA: mostramos SOLO la forma de pago.
  if(isEnvio){
    const subLine  = $("rSubLine");
    const discLine = $("rDiscLine");
    const payLine  = $("rPayLine");
    const totLine  = $("rTotalLine");
    if(subLine) subLine.classList.add("hide");
    if(discLine) discLine.classList.add("hide");
    if(payLine) payLine.classList.add("hide");
    if(totLine) totLine.classList.add("hide");

    const line = document.createElement("div");
    line.className = "line";
    if(pay === "EFECTIVO"){
      line.innerHTML = `<span>Total</span><span>${money(s.total ?? cartTotal())}</span>`;
    }else{
      line.innerHTML = `<span>Pago</span><span>${escapeHtml(pay)}</span>`;
    }
    itemsDiv.appendChild(line);
  }else{
    // MOSTRADOR: comportamiento actual (detalle + totales)
    const subLine  = $("rSubLine");
    const discLine = $("rDiscLine");
    const payLine  = $("rPayLine");
    const totLine  = $("rTotalLine");
    if(subLine) subLine.classList.remove("hide");
    if(discLine) discLine.classList.remove("hide");
    if(payLine) payLine.classList.remove("hide");
    if(totLine) totLine.classList.remove("hide");

    for(const it of (s.items||[])){
      const line = document.createElement("div");
      line.className="line";
      line.innerHTML = `<span>${it.qty} x ${escapeHtml(it.name)}</span><span>${money(it.qty*it.price)}</span>`;
      itemsDiv.appendChild(line);
    }

    $("rSub").textContent = money(s.subtotal ?? cartSubtotal());
    $("rDisc").textContent = money(s.discountAmount ?? cartDiscountAmount(s.subtotal ?? cartSubtotal()));
    $("rTotal").textContent = money(s.total ?? cartTotal());
  }
  // Asegura logo visible tambi√©n en MOSTRADOR (usa DataURL si ya se carg√≥)
  try{ ensureLogosSafe($("receiptBox")); }catch(e){}
}

async function copyReceipt(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  try{
    await navigator.clipboard.writeText(text);
    alert("Recibo copiado. P√©galo en WhatsApp.");
  }catch{
    alert("No se pudo copiar autom√°ticamente. Intenta copiar manualmente desde WhatsApp.");
  }
}

function openWhatsApp(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}


// --- Seguridad (c√≥digo para borrar/editar) ---
function requireCode(action){
  const code = prompt(`Ingrese el c√≥digo para ${action}:`);
  if(code===null) return false;
  if(String(code).trim() !== "363534"){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}

// --- Seguridad (c√≥digo para backup/restore) ---
function requireBackupCode(action){
  const code = prompt(`Ingrese el c√≥digo para ${action}:`);
  if(code===null) return false;
  if(String(code).trim() !== "22782522"){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}

// --- Captura PNG robusta (evita blanco/opaco) ---
async function capturePNG(node, filename, scaleOverride=null){
  if(!node) throw new Error("Nodo no encontrado.");
  if(!window.html2canvas) throw new Error("html2canvas no disponible.");

  document.body.classList.add("capture-mode");
  await new Promise(r=>requestAnimationFrame(r));

  const scale = scaleOverride ? Number(scaleOverride) : 2;

  // 1) Antes de capturar, intentamos "sanear" logos para evitar canvas tainted
  await ensureLogosSafe(node);

  async function doCapture(){
    const canvas = await html2canvas(node, {
      backgroundColor:"#ffffff",
      scale: Math.max(1, Math.min(4, scale)),
      useCORS: true,
      allowTaint: false,      // importante: si queda tainted, preferimos fallar y reintentar con logo inline
      logging: false,
      removeContainer: true
    });

    return await new Promise((resolve,reject)=>{
      canvas.toBlob((blob)=>{
        if(!blob) return reject(new Error("PNG bloqueado o en blanco."));
        const a = document.createElement("a");
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 3000);
        resolve(true);
      }, "image/png", 1.0);
    });
  }

  try{
    return await doCapture();
  }catch(e){
    const msg = (e && e.message) ? String(e.message) : String(e||"");
    // Error t√≠pico: "Tainted canvases may not be exported"
    if(/tainted|exported|toBlob/i.test(msg)){
      // Si no tenemos logo inline guardado, pedimos cargarlo una vez y reintentamos
      let data = localStorage.getItem(LOGO_DATAURL_KEY);
      if(!data){
        const picked = await promptLogoUpload();
        if(picked){
          await ensureLogosSafe(node);
          return await doCapture();
        }
      }else{
        await ensureLogosSafe(node);
        return await doCapture();
      }
    }
    throw e;
  }finally{
    document.body.classList.remove("capture-mode");
  }
}
// ====== LABEL 10x10 (ENV√çO) helpers ======
const ENV_LABEL_MM = 100;                 // 10cm
const ENV_LABEL_MARGIN_MM = 3;            // margen impresi√≥n (ajusta si tu impresora lo necesita)
const ENV_LABEL_PX = Math.round(ENV_LABEL_MM * 96 / 25.4); // 100mm -> ~378px (a 96dpi)

/** Construye un nodo 10x10 para ENV√çO (para PNG) */
/** Construye un nodo 10x10 para ENV√çO (para PNG) */
function buildEnvLabelNode(s){
  const wrap = document.createElement("div");
  wrap.id = "envLabelTmp";
  wrap.style.width = ENV_LABEL_PX + "px";
  wrap.style.height = ENV_LABEL_PX + "px";
  wrap.style.background = "#fff";
  wrap.style.position = "fixed";
  wrap.style.left = "-99999px";
  wrap.style.top = "0";
  wrap.style.padding = "10px";
  wrap.style.boxSizing = "border-box";
  wrap.style.border = "1px solid rgba(0,0,0,.08)";
  wrap.style.overflow = "hidden";
  wrap.style.fontFamily = "Arial, sans-serif";

  // Layout: header + contenido + footer (footer pegado abajo)
  wrap.style.display = "flex";
  wrap.style.flexDirection = "column";
  wrap.style.gap = "6px";

  // ====== DATOS ======
  const shop = (s.shop || state?.settings?.shopName || "Tienda").toString();
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const envioNo = (s.receiptNo || "----").toString();
  const status = (s.status || "PENDIENTE").toString().toUpperCase();

  const client = s.client ? `${s.client.names || ""} ${s.client.last || ""}`.trim() : "MOSTRADOR";
  const phone  = s.client?.phone || "‚Äî";
  const addr   = s.client?.addr  || "‚Äî";

  // Comentario / indicaciones (varios nombres posibles)
  const indic = (s.client?.indic ?? s.client?.comment ?? s.comment ?? s.shipComment ?? "‚Äî");

  // Total / Pago
  const total = (s.total ?? s.grandTotal ?? 0);
  const pay   = (s.payMethod || s.paymentMethod || "EFECTIVO").toString().toUpperCase();
  const isCash = (pay === "EFECTIVO" || pay === "CASH");

  // Logo: preferir DataURL guardado para evitar fallos al exportar
  const logoSrc = localStorage.getItem(LOGO_DATAURL_KEY) || "LOGO1.png";

  // ====== CABECERA (Logo + Tienda + # Env√≠o) ======
  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.alignItems = "center";
  header.style.justifyContent = "space-between";
  header.style.gap = "8px";

  const left = document.createElement("div");
  left.style.lineHeight = "1.05";
  left.innerHTML = `
    <div style="font-weight:1000;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(shop)}</div>
    <div style="font-weight:1000;font-size:14px;">ENV√çO #${escapeHtml(envioNo)}</div>
    <div style="font-weight:900;font-size:10px;color:#555;">${escapeHtml(d)}</div>
  `;

  const logo = document.createElement("img");
  logo.src = logoSrc;
  logo.alt = "LOGO";
  logo.style.height = "60px";
  logo.style.width = "60px";
  logo.style.objectFit = "contain";
  logo.style.borderRadius = "10px";
  logo.style.border = "1px solid rgba(0,0,0,.08)";
  logo.style.padding = "3px";
  logo.style.background = "#fff";
  logo.onerror = ()=>{ logo.style.display="none"; };

  header.appendChild(left);
  header.appendChild(logo);
  wrap.appendChild(header);

  // ====== CLIENTE / TEL (tel m√°s grande) ======
  const info = document.createElement("div");
  info.style.lineHeight = "1.12";
  info.innerHTML = `
    <div style="font-weight:1000;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(client)}</div>
    <div style="font-weight:1100;font-size:15px;letter-spacing:.2px;">${escapeHtml(phone)}</div>
    <div style="font-weight:900;font-size:10px;color:#0e5b2a;">${escapeHtml(status)}</div>
  `;
  wrap.appendChild(info);

  // ====== CONTENIDO (Direcci√≥n + Indicaciones) ======
  const content = document.createElement("div");
  content.style.flex = "1 1 auto";
  content.style.minHeight = "0";
  content.style.border = "1px solid rgba(0,0,0,.12)";
  content.style.borderRadius = "8px";
  content.style.padding = "6px";
  content.style.boxSizing = "border-box";
  content.style.overflow = "hidden";
  content.style.lineHeight = "1.15";

  const addrEl = document.createElement("div");
  addrEl.style.fontWeight = "1000";
  addrEl.style.whiteSpace = "pre-wrap";
  addrEl.style.wordBreak = "break-word";
  addrEl.style.overflowWrap = "anywhere";
  addrEl.textContent = "Direcci√≥n: " + (addr || "‚Äî");

  const commEl = document.createElement("div");
  commEl.style.marginTop = "5px";
  commEl.style.fontWeight = "900";
  commEl.style.whiteSpace = "pre-wrap";
  commEl.style.wordBreak = "break-word";
  commEl.style.overflowWrap = "anywhere";
  commEl.textContent = "Indicaciones: " + (indic || "‚Äî");

  content.appendChild(addrEl);
  content.appendChild(commEl);
  wrap.appendChild(content);

  // ====== FOOTER (pegado abajo) ======
  const payBox = document.createElement("div");
  payBox.style.marginTop = "auto";
  payBox.style.borderTop = "1px solid rgba(0,0,0,.12)";
  payBox.style.paddingTop = "6px";
  payBox.style.lineHeight = "1.05";

  payBox.innerHTML = isCash
    ? `
      <div style="display:flex;justify-content:space-between;font-weight:1200;font-size:18px;">
        <span>TOTAL</span><span>${money(total)}</span>
      </div>
    `
    : `
      <div style="display:flex;justify-content:space-between;font-weight:1200;font-size:16px;">
        <span>PAGO</span><span>${escapeHtml(pay)}</span>
      </div>
    `;

  wrap.appendChild(payBox);

  return wrap;
}

function fitEnvLabelToBox(node){
  // bajamos font-size global del contenedor hasta que no desborde
  let fs = 12; // arranque
  node.style.fontSize = fs + "px";

  // intentamos hasta 6px
  for(let i=0;i<20;i++){
    // si desborda, bajamos
    if(node.scrollHeight > node.clientHeight || node.scrollWidth > node.clientWidth){
      fs -= 0.5;
      node.style.fontSize = fs + "px";
      if(fs <= 6) break;
    }else{
      break;
    }
  }
}


// PNG (preferir html2canvas; fallback SVG)
// PNG (preferir html2canvas; fallback SVG)
async function downloadReceiptPNG(){
  const s = state.lastReceipt || makeLiveReceipt();
  const isEnv = (s.saleType === "ENVIO");

  // ====== ENV√çO: PNG 10x10 usando label temporal ======
  if(isEnv){
    if(!window.html2canvas){
      alert("html2canvas no est√° disponible. Usa PDF.");
      return;
    }

    const node = buildEnvLabelNode(s);
    document.body.appendChild(node);
    fitEnvLabelToBox(node);
    await ensureLogoOrAsk(node);

    try{
      const scale = Number(state.settings.envPngScale || 2);
      await capturePNG(node, `envio_${(s.receiptNo||"----")}_10x10.png`, scale);
    }catch(e){
      alert("No se pudo generar PNG de ENV√çO. Intenta con PDF. " + (e?.message||""));
    }finally{
      node.remove();
    }
    return;
  }

  // ====== MOSTRADOR: PNG desde #receiptBox ======
  const node = $("receiptBox");
  if(!node) return;

  // 1) html2canvas robusto
  if(window.html2canvas){
    try{
      await capturePNG(node, `recibo_${(s.receiptNo||"----")}.png`, 2);
      return;
    }catch(e){
      // seguimos al fallback
    }
  }

  // 2) fallback SVG foreignObject
  const w = node.offsetWidth;
  const h = node.offsetHeight;

  const clone = node.cloneNode(true);
  clone.style.boxShadow="none";

  const wrapper = document.createElement("div");
  wrapper.style.width = w+"px";
  wrapper.style.height = h+"px";
  wrapper.style.background = "#fff";
  wrapper.appendChild(clone);

  const html = new XMLSerializer().serializeToString(wrapper);
  const data = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
      <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">
          ${html}
        </div>
      </foreignObject>
    </svg>
  `;
  const svgBlob = new Blob([data], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = ()=>{
    const cnv = $("cnv");
    const sc = 2;
    cnv.width = w*sc;
    cnv.height = h*sc;

    const ctx = cnv.getContext("2d");
    ctx.setTransform(sc,0,0,sc,0,0);
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,w,h);
    ctx.drawImage(img, 0,0);
    URL.revokeObjectURL(url);

    cnv.toBlob((blob)=>{
      if(!blob) return alert("Tu navegador bloque√≥ el PNG. Usa PDF o Copiar texto.");
      const a = document.createElement("a");
      const u = URL.createObjectURL(blob);
      a.href = u;
      a.download = `recibo_${(s.receiptNo||"----")}.png`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(u), 1000);
    }, "image/png");
  };
  img.onerror = ()=>{
    URL.revokeObjectURL(url);
    alert("Tu navegador bloque√≥ el PNG. Usa PDF o Copiar texto.");
  };
  img.src = url;
}

function receiptToPrintableHTML(s){
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const clientName = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr  || "‚Äî";

  const rows = (s.items||[]).map(it=>{
    const line = (it.qty||0) * (it.price||0);
    return `
      <tr>
        <td style="text-align:center">${it.qty}</td>
        <td>${escapeHtml(it.name)}</td>
        <td style="text-align:right">${money(it.price)}</td>
        <td style="text-align:right">${money(line)}</td>
      </tr>
    `;
  }).join("");

  const sub = Number(s.subtotal ?? 0);
  const disc = Number(s.discountAmount ?? 0);
  const total = Number(s.total ?? 0);
  const pay = (s.payMethod || s.paymentMethod || "EFECTIVO").toString().toUpperCase();

  const logoSrc = localStorage.getItem(LOGO_DATAURL_KEY) || "LOGO1.png";

  const isEnv = (s.saleType === "ENVIO");

  const pageW = ENV_LABEL_MM;        // 100mm
  const pageH = ENV_LABEL_MM;        // 100mm
  const pageM = ENV_LABEL_MARGIN_MM; // 3mm

  const pageCss = isEnv
    ? `@page{ size: ${pageW}mm ${pageH}mm; margin: ${pageM}mm; }`
    : `@page{ margin: 12mm; }`;

  const boxWidth = isEnv
    ? `max-width: ${Math.max(50, Math.min(120, pageW))}mm;`
    : `max-width: 820px;`;

  // Para ENV√çO, forzamos una altura real (√°rea imprimible) para que el "fit" funcione y no se corte.
  const boxExtra = isEnv
    ? `height: ${Math.max(10, (pageH - (pageM*2)))}mm; display:flex; flex-direction:column;`
    : ``;

  const statusLine = s.status
    ? `<div class="meta" style="margin-top:6px;color:#a16207;font-weight:900">Estatus: ${escapeHtml(s.status)}</div>`
    : ``;

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Recibo ${escapeHtml(s.receiptNo || "")}</title>

    <style>
      ${pageCss}
      body{ font-family: Arial, sans-serif; margin: 0; color:#111; background:#fff7fb; }
      .box{ position:relative; ${boxWidth} ${boxExtra} margin: 0 auto; border:2px solid #fbcfe8; border-radius:16px; padding:16px; background:#fff; box-sizing:border-box; overflow:hidden; }
      .cornerLogo{ position:absolute; top:12px; right:12px; width:60px; height:60px; object-fit:contain; border-radius:14px; border:1px solid #eee; padding:4px; background:#fff; }
      .bar{ height:8px; border-radius:999px; background: linear-gradient(90deg, #ff4fb7, #a855f7); margin-bottom:12px; }
      h1{ margin:0; font-size:18px; color:#7b2fb4; padding-right:70px; }
      .meta{ margin-top:4px; color:#444; font-size:12px; font-weight:700; }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
      .card{ border:1px solid #eee; border-radius:12px; padding:12px; }
      .label{ color:#666; font-size:12px; font-weight:700; }
      .val{ font-size:13px; font-weight:800; margin-top:3px; white-space:pre-wrap; word-break:break-word; }
      table{ width:100%; border-collapse:collapse; margin-top:14px; }
      th,td{ border-bottom:1px solid #eee; padding:8px; font-size:13px; }
      th{ background:#ffe4f1; text-align:left; }
      .totalRow{ display:flex; justify-content:space-between; margin-top:10px; font-weight:1000; font-size:14px; }
      .box .footer .totalRow{ font-size:16px; }
      .foot{ margin-top:12px; color:#444; font-size:12px; font-weight:700; }
      .content{ flex:1 1 auto; min-height:0; }
      .footer{ margin-top:auto; }
      .phoneBig{ font-size:16px; font-weight:1000; }

      @media print{
        body{ background:#fff; }
        .box{ border:none; border-radius:0; }
      }
    </style>

    <script>
      // Ajusta el contenido SOLO para ENV√çO (10x10) bajando font-size si se desborda
      (function(){
        var IS_ENV = ${isEnv ? "true" : "false"};

        function fit(){
          if(!IS_ENV) return;

          var box = document.querySelector('.box');
          if(!box) return;

          // Si no hay una altura real, no intentes medir
          if(box.clientHeight === 0 || box.clientWidth === 0) return;

          var fs = 12;
          box.style.fontSize = fs + 'px';

          for(var i=0;i<40;i++){
            var overflowH = box.scrollHeight > box.clientHeight;
            var overflowW = box.scrollWidth  > box.clientWidth;

            if(overflowH || overflowW){
              fs -= 0.5;
              box.style.fontSize = fs + 'px';
              if(fs <= 6) break;
            }else{
              break;
            }
          }
        }

window.addEventListener('load', function(){
  // 2 pasadas para asegurar layout + im√°genes
  if(typeof fit === "function"){
    fit();
    setTimeout(fit, 150);
    setTimeout(fit, 350);
  }

  // Bot√≥n para elegir carpeta de backups
  const btnPick = document.getElementById("btnPickBackupFolder");
  if(btnPick){
    btnPick.addEventListener("click", async function(){
      try{
        await pickBackupFolder();
      }catch(err){
        console.error(err);
        alert("No se pudo abrir el selector de carpeta. Usa Chrome/Edge y abre en https/localhost.\n\nDetalle: " + (err?.message || err));
      }
    });
  }else{
    // Solo para debug
    console.warn("No existe #btnPickBackupFolder al cargar (puede estar en otra vista).");
  }
});


      })();
    <\/script>
  </head>

  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <img class="cornerLogo" src="${logoSrc}" onerror="this.style.display='none'" alt="Logo" />
      <div class="bar"></div>
      <h1>${escapeHtml(s.shop || "Tienda de Ropa")} ‚Äî Recibo #${escapeHtml(s.receiptNo || "")}</h1>
      <div class="meta">${escapeHtml(d)} ‚Ä¢ Tipo: ${escapeHtml(s.saleType || "MOSTRADOR")}${isEnv ? "" : " ‚Ä¢ Pago: " + escapeHtml(s.payMethod || "EFECTIVO")}</div>
      ${statusLine}

      <div class="content">
      <div class="grid">
        <div class="card">
          <div class="label">Cliente</div>
          <div class="val">${escapeHtml(clientName)}</div>
          <div class="label" style="margin-top:10px">Tel√©fono</div>
          <div class="val ${isEnv ? "phoneBig" : ""}">${escapeHtml(phone)}</div>
        </div>
        <div class="card">
          <div class="label">Direcci√≥n</div>
          <div class="val">${escapeHtml(addr)}</div>
        </div>
        ${isEnv ? `
        <div class="card">
          <div class="label">Indicaciones</div>
          <div class="val">${escapeHtml(indic)}</div>
        </div>
        ` : ``}
      </div>

      ${isEnv ? `` : `
      <table>
        <thead>
          <tr>
            <th style="width:70px;text-align:center">Cant</th>
            <th>Producto</th>
            <th style="width:120px;text-align:right">Precio</th>
            <th style="width:120px;text-align:right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="4">Sin items</td></tr>`}
        </tbody>
      </table>
      `}
      </div>
      <div class="footer">

      ${isEnv
        ? ( (pay === "EFECTIVO" || pay === "CASH")
            ? `<div class="totalRow"><div>TOTAL</div><div>${money(total)}</div></div>`
            : `<div class="totalRow"><div>PAGO</div><div>${escapeHtml(pay)}</div></div>` )
        : `
      <div class="totalRow"><div>SUBTOTAL</div><div>${money(sub)}</div></div>
      <div class="totalRow"><div>DESCUENTO</div><div>${money(disc)}</div></div>
      <div class="totalRow"><div>TOTAL</div><div>${money(total)}</div></div>
      `}

      <div class="foot">Gracias por tu compra üíó</div>
      </div>
    </div>
  </body>
  </html>
  `;
}


function generatePDF(){
  const s = state.lastReceipt || makeLiveReceipt();

  if(s.saleType === "ENVIO"){
    const ok = s.client && s.client.phone && s.client.names && s.client.last && s.client.addr;
    if(!ok) return alert("Para ENV√çO debes tener cliente completo antes de generar el PDF.");
  }

  const html = receiptToPrintableHTML(s);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para generar PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// ---------- Cierre ----------
function closeToText(c){
  if(!c) return "No hay cierre todav√≠a.";
  const lines = [];
  lines.push(`üßæ *${c.shop}*`);
  lines.push(`CIERRE DE VENTAS ‚Äî ${c.dateKey} (${c.fromHHMM} - ${c.toHHMM})`);
  lines.push(`Generado: ${new Date(c.ts).toLocaleString()}`);
  lines.push(`--------------------------------`);
  lines.push(`Ventas: ${c.salesCount}`);
  lines.push(`Mostrador: ${c.mostradorCount} | Env√≠os: ${c.envioCount}`);
  lines.push(`--------------------------------`);
  lines.push(`EFECTIVO: ${money(c.pay.EFECTIVO)}`);
  lines.push(`TARJETA: ${money(c.pay.TARJETA)}`);
  lines.push(`TRANSFERENCIA: ${money(c.pay.TRANSFERENCIA)}`);
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(c.subtotal)}`);
  lines.push(`DESCUENTOS: ${money(c.discounts)}`);
  lines.push(`TOTAL: *${money(c.total)}*`);
  lines.push(`--------------------------------`);
  lines.push(`CUADRE (Real - Sistema):`);
  lines.push(`EFECTIVO: ${money(c.diff?.EFECTIVO||0)}`);
  lines.push(`TARJETA: ${money(c.diff?.TARJETA||0)}`);
  lines.push(`TRANSFER.: ${money(c.diff?.TRANSFERENCIA||0)}`);
  lines.push(`TOTAL: ${money(c.diffTotal||0)}`);
  lines.push(`--------------------------------`);
  lines.push(`Productos vendidos:`);
  for(const p of c.products){
    lines.push(`- ${p.qty} x ${p.name} (${p.code})`);
  }
  lines.push(`--------------------------------`);
  lines.push(`Cierre generado ‚úÖ`);
  return lines.join("\n");
}

function closeToPrintableHTML(c){
  const rows = c.products.map(p=>`
    <tr>
      <td style="text-align:center">${p.qty}</td>
      <td>${escapeHtml(p.name)}<br><small>${escapeHtml(p.code)}</small></td>
    </tr>
  `).join("");

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Cierre ${escapeHtml(c.dateKey)}</title>
    <style>
      body{ font-family: Arial, sans-serif; margin: 20px; color:#111; background:#fff7fb; }
     <style>
  body{ 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    color:#111; 
    background:#fff7fb; 
  }

  .box{
    position:relative;
    width:100mm;
    height:100mm;
    overflow:hidden;
    margin:0 auto;
    border:2px solid #fbcfe8;
    border-radius:16px;
    padding:10px;
    background:#fff;
    box-sizing:border-box;
  }

  .cornerLogo{ 
    position:absolute; 
    top:12px; 
    right:12px; 
    width:60px; 
    height:60px; 
    object-fit:contain; 
    border-radius:14px; 
    border:1px solid #eee; 
    padding:4px; 
    background:#fff; 
  }

  .bar{ 
    height:8px; 
    border-radius:999px; 
    background: linear-gradient(90deg, #ff4fb7, #a855f7); 
    margin-bottom:12px; 
  }

  h1{ 
    margin:0; 
    font-size:18px; 
    color:#7b2fb4; 
    padding-right:70px; 
  }

  .meta{ 
    margin-top:4px; 
    color:#444; 
    font-size:12px; 
    font-weight:700; 
  }

  .line{ 
    display:flex; 
    justify-content:space-between; 
    gap:12px; 
    font-weight:800; 
    margin:6px 0; 
  }

  table{ 
    width:100%; 
    border-collapse:collapse; 
    margin-top:14px; 
  }

  th,td{ 
    border-bottom:1px solid #eee; 
    padding:8px; 
    font-size:13px; 
  }

  th{ 
    background:#ffe4f1; 
    text-align:left; 
  }

  @media print{
    body{ margin:0; }
    .box{ border:none; border-radius:0; }
  }

    </style>
  </head>
  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <img class="cornerLogo" src="LOGO1.png" onerror="this.style.display='none'" alt="Logo" />
      <div class="bar"></div>
      <h1>${escapeHtml(c.shop)} ‚Äî Cierre ${escapeHtml(c.dateKey)} (${escapeHtml(c.fromHHMM)}-${escapeHtml(c.toHHMM)})</h1>
      <div class="meta">Generado: ${escapeHtml(new Date(c.ts).toLocaleString())}</div>

      <div class="line"><span>Ventas</span><span>${c.salesCount}</span></div>
      <div class="line"><span>Mostrador</span><span>${c.mostradorCount}</span></div>
      <div class="line"><span>Env√≠os</span><span>${c.envioCount}</span></div>
      <hr>

      <div class="line"><span>EFECTIVO</span><span>${money(c.pay.EFECTIVO)}</span></div>
      <div class="line"><span>TARJETA</span><span>${money(c.pay.TARJETA)}</span></div>
      <div class="line"><span>TRANSFERENCIA</span><span>${money(c.pay.TRANSFERENCIA)}</span></div>
      <hr>

      <div class="line"><span>SUBTOTAL</span><span>${money(c.subtotal)}</span></div>
      <div class="line"><span>DESCUENTOS</span><span>${money(c.discounts)}</span></div>
      <div class="line"><span>TOTAL</span><span>${money(c.total)}</span></div>

      <div style="font-size:12px; font-weight:900; margin:8px 0 6px; color:#666">CUADRE (Real - Sistema)</div>
      <div class="line"><span>Real EFECTIVO</span><span>${money((c.real?.EFECTIVO||0))}</span></div>
      <div class="line"><span>Dif. EFECTIVO</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diff?.EFECTIVO||0)}</span></div>
      <div class="line"><span>Real TARJETA</span><span>${money((c.real?.TARJETA||0))}</span></div>
      <div class="line"><span>Dif. TARJETA</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diff?.TARJETA||0)}</span></div>
      <div class="line"><span>Real TRANSF.</span><span>${money((c.real?.TRANSFERENCIA||0))}</span></div>
      <div class="line"><span>Dif. TRANSF.</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diff?.TRANSFERENCIA||0)}</span></div>
      <div class="line"><span>Dif. TOTAL</span><span>${(function(v){const n=Number(v||0);const tag=n>0?"SOBRA":(n<0?"FALTA":"CUADRADO");return money(n)+" ("+tag+")";})(c.diffTotal||0)}</span></div>

      <h3 style="margin-top:14px">Cuadre (Real - Sistema)</h3>
      <div class="line"><span>EFECTIVO</span><span>${money(c.diff?.EFECTIVO||0)}</span></div>
      <div class="line"><span>TARJETA</span><span>${money(c.diff?.TARJETA||0)}</span></div>
      <div class="line"><span>TRANSFER.</span><span>${money(c.diff?.TRANSFERENCIA||0)}</span></div>
      <div class="line"><span>TOTAL</span><span>${money(c.diffTotal||0)}</span></div>

      <h3 style="margin-top:14px">Productos vendidos</h3>
      <table>
        <thead><tr><th style="width:80px;text-align:center">Cant</th><th>Producto</th></tr></thead>
        <tbody>${rows || `<tr><td colspan="2">Sin ventas</td></tr>`}</tbody>
      </table>

      <div style="margin-top:12px; color:#444; font-size:12px; font-weight:700;">Cierre generado ‚úÖ</div>
    </div>
  </body>
  </html>
  `;
}

async function buildClose(){
  const dateKey = $("closeDate").value || todayKey();
  const rawFrom = $("closeFrom").value;
  const rawTo   = $("closeTo").value;
  let fromHHMM = rawFrom;
  let toHHMM   = rawTo;

  // ‚úÖ Si no defines rango manual, usamos TURNO (desde shiftStartTs hasta ahora)
  if((!fromHHMM || !toHHMM) && dateKey===todayKey()){
    const shiftStart = await getShiftStartTs();
    if(shiftStart){
      const a = new Date(Number(shiftStart));
      const b = new Date();
      if(!fromHHMM) fromHHMM = a.toTimeString().slice(0,5);
      if(!toHHMM)   toHHMM   = b.toTimeString().slice(0,5);
      if(!rawFrom) $("closeFrom").value = fromHHMM;
      if(!rawTo)   $("closeTo").value   = toHHMM;
    }
  }

  fromHHMM = fromHHMM || "00:00";
  toHHMM   = toHHMM   || "23:59";

  const all = await idbAll("sales");
  const list = all.filter(s=> isWithinDateRange(s.ts, dateKey, fromHHMM, toHHMM)).sort((a,b)=>a.ts-b.ts);

  const pay = {EFECTIVO:0, TARJETA:0, TRANSFERENCIA:0};
  let subtotal = 0;
  let discounts = 0;
  let total = 0;
  let envioCount = 0;
  let mostradorCount = 0;

  const prodMap = new Map();

  for(const s of list){
    subtotal += Number(s.subtotal ?? s.total ?? 0);
    discounts += Number(s.discountAmount ?? 0);
    total += Number(s.total ?? 0);

    if(s.saleType==="ENVIO") envioCount++; else mostradorCount++;

    pay[s.payMethod] = (pay[s.payMethod]||0) + Number(s.total||0);

    for(const it of (s.items||[])){
      const key = it.code;
      const cur = prodMap.get(key) || {code:it.code, name:it.name, qty:0};
      cur.qty += Number(it.qty||0);
      cur.name = it.name;
      prodMap.set(key, cur);
    }
  }

  const products = [...prodMap.values()].sort((a,b)=>b.qty-a.qty);

  // render historial tabla
  const hb = $("closeHistBody");
  hb.innerHTML = "";
  for(const s of list){
    const tr = document.createElement("tr");
    const d = new Date(s.ts);
    const when = d.toLocaleTimeString();
    const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(client)}</td>
      <td>${escapeHtml(s.saleType||"")}</td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
    `;
    hb.appendChild(tr);
  }

  // Cuadre
  const realCash = Number($("realCash").value||0);
  const realCard = Number($("realCard").value||0);
  const realTrans= Number($("realTrans").value||0);

  const diff = {
    EFECTIVO: Number((realCash - (pay.EFECTIVO||0)).toFixed(2)),
    TARJETA: Number((realCard - (pay.TARJETA||0)).toFixed(2)),
    TRANSFERENCIA: Number((realTrans - (pay.TRANSFERENCIA||0)).toFixed(2))
  };
  const diffTotal = Number((diff.EFECTIVO + diff.TARJETA + diff.TRANSFERENCIA).toFixed(2));

  // mostrar difs
  $("diffCash").textContent = money(diff.EFECTIVO);
  $("diffCard").textContent = money(diff.TARJETA);
  $("diffTrans").textContent = money(diff.TRANSFERENCIA);
  $("diffTotal").textContent = money(diffTotal);

  const close = {
    id: "C-TMP",
    ts: Date.now(),
    dateKey,
    fromHHMM,
    toHHMM,
    shop: state.settings.shopName || "Tienda de Ropa",
    salesCount: list.length,
    envioCount,
    mostradorCount,
    pay,
    subtotal: Number(subtotal.toFixed(2)),
    discounts: Number(discounts.toFixed(2)),
    total: Number(total.toFixed(2)),
    products,
    real: {EFECTIVO: realCash, TARJETA: realCard, TRANSFERENCIA: realTrans},
    diff,
    diffTotal
  };

  state.lastClose = close;

  // pintar ticket de cierre
  $("cShop").textContent = close.shop;
  $("cMeta").textContent = `Cierre ‚Ä¢ ${close.fromHHMM}-${close.toHHMM}`;
  $("cDate").textContent = close.dateKey;
  $("cTime").textContent = new Date(close.ts).toLocaleString();

  $("cSales").textContent = String(close.salesCount);
  $("cMost").textContent = String(close.mostradorCount);
  $("cEnv").textContent = String(close.envioCount);

  $("cCash").textContent = money(close.pay.EFECTIVO||0);
  $("cCard").textContent = money(close.pay.TARJETA||0);
  $("cTrans").textContent = money(close.pay.TRANSFERENCIA||0);

  $("cSub").textContent = money(close.subtotal);
  $("cDisc").textContent = money(close.discounts);
  $("cTotal").textContent = money(close.total);

  // ‚úÖ Cuadre en el ticket (con etiqueta SOBRA/FALTA)
  const fmtDiffTag = (v)=>{
    const n = Number(v||0);
    const tag = n>0 ? "SOBRA" : (n<0 ? "FALTA" : "CUADRADO");
    return `${money(n)} (${tag})`;
  };
  if($("cRealCash")) $("cRealCash").textContent = money(close.real?.EFECTIVO||0);
  if($("cRealCard")) $("cRealCard").textContent = money(close.real?.TARJETA||0);
  if($("cRealTrans")) $("cRealTrans").textContent = money(close.real?.TRANSFERENCIA||0);
  if($("cDiffCash")) $("cDiffCash").textContent = fmtDiffTag(close.diff?.EFECTIVO||0);
  if($("cDiffCard")) $("cDiffCard").textContent = fmtDiffTag(close.diff?.TARJETA||0);
  if($("cDiffTrans")) $("cDiffTrans").textContent = fmtDiffTag(close.diff?.TRANSFERENCIA||0);
  if($("cDiffTotal")) $("cDiffTotal").textContent = fmtDiffTag(close.diffTotal||0);

  const cp = $("cProducts");
  cp.innerHTML = "";
  if(close.products.length===0){
    const div = document.createElement("div");
    div.className="muted";
    div.textContent = "Sin ventas en este rango.";
    cp.appendChild(div);
  }else{
    for(const p of close.products.slice(0,50)){
      const div = document.createElement("div");
      div.className="line";
      div.innerHTML = `<span>${p.qty} x ${escapeHtml(p.name)}</span><span><small>${escapeHtml(p.code)}</small></span>`;
      cp.appendChild(div);
    }
  }
}

async function saveClose(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
 

  const c = {...state.lastClose};
  c.id = "C-" + c.ts + "-" + Math.random().toString(16).slice(2,8);
  await idbPut("closes", c);

  await clearPaidShipments();
  await renderSavedCloses();

  await autoBackupToFolder("cierre"); // ya lo tienes ‚úÖ

  // ‚úÖ reset por turno
  await setShiftStartTs(Date.now());
  await refreshKPIs();

  // ‚úÖ Reset del panel de previsualizaci√≥n para el siguiente cierre
  $("realCash").value = 0;
  $("realCard").value = 0;
  $("realTrans").value = 0;
  $("diffCash").textContent = money(0);
  $("diffCard").textContent = money(0);
  $("diffTrans").textContent = money(0);
  $("diffTotal").textContent = money(0);
  $("closeFrom").value = "";
  $("closeTo").value = "";
  $("closeDate").value = todayKey();
  state.lastClose = null;
  await buildClose();

  alert("Cierre guardado ‚úÖ");
}


async function renderSavedCloses(){
  const dateKey = $("closeDate").value || todayKey();
  const all = await idbAll("closes");
  const list = all.filter(x=>x.dateKey===dateKey).sort((a,b)=>b.ts-a.ts);

  const tb = $("closeSavedBody");
  tb.innerHTML = "";
  for(const c of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(c.dateKey)}</small><br><small>${escapeHtml(new Date(c.ts).toLocaleString())}</small></td>
      <td><b>${escapeHtml(c.fromHHMM||"")}</b> - <b>${escapeHtml(c.toHHMM||"")}</b></td>
      <td>${escapeHtml(String(c.salesCount||0))}</td>
      <td>${money(c.total||0)}</td>
      <td>
        <button class="btn small" data-viewclose="${escapeHtml(c.id)}">Ver</button>
        <button class="btn danger small" data-delclose="${escapeHtml(c.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function viewSavedClose(id){
  const c = await idbGet("closes", id);
  if(!c) return;
  state.lastClose = c;
  // cargar inputs (sin tocar los reales)
  $("closeDate").value = c.dateKey;
  $("closeFrom").value = c.fromHHMM;
  $("closeTo").value = c.toHHMM;

  $("realCash").value = c.real?.EFECTIVO ?? 0;
  $("realCard").value = c.real?.TARJETA ?? 0;
  $("realTrans").value = c.real?.TRANSFERENCIA ?? 0;

  // render ticket / difs
  $("diffCash").textContent = money(c.diff?.EFECTIVO||0);
  $("diffCard").textContent = money(c.diff?.TARJETA||0);
  $("diffTrans").textContent = money(c.diff?.TRANSFERENCIA||0);
  $("diffTotal").textContent = money(c.diffTotal||0);

  // pintar ticket cierre como en buildClose:
  $("cShop").textContent = c.shop;
  $("cMeta").textContent = `Cierre ‚Ä¢ ${c.fromHHMM}-${c.toHHMM}`;
  $("cDate").textContent = c.dateKey;
  $("cTime").textContent = new Date(c.ts).toLocaleString();

  $("cSales").textContent = String(c.salesCount);
  $("cMost").textContent = String(c.mostradorCount);
  $("cEnv").textContent = String(c.envioCount);

  $("cCash").textContent = money(c.pay?.EFECTIVO||0);
  $("cCard").textContent = money(c.pay?.TARJETA||0);
  $("cTrans").textContent = money(c.pay?.TRANSFERENCIA||0);

  $("cSub").textContent = money(c.subtotal||0);
  $("cDisc").textContent = money(c.discounts||0);
  $("cTotal").textContent = money(c.total||0);

  const fmtDiffTag = (v)=>{
    const n = Number(v||0);
    const tag = n>0 ? "SOBRA" : (n<0 ? "FALTA" : "CUADRADO");
    return `${money(n)} (${tag})`;
  };
  if($("cRealCash")) $("cRealCash").textContent = money(c.real?.EFECTIVO||0);
  if($("cRealCard")) $("cRealCard").textContent = money(c.real?.TARJETA||0);
  if($("cRealTrans")) $("cRealTrans").textContent = money(c.real?.TRANSFERENCIA||0);
  if($("cDiffCash")) $("cDiffCash").textContent = fmtDiffTag(c.diff?.EFECTIVO||0);
  if($("cDiffCard")) $("cDiffCard").textContent = fmtDiffTag(c.diff?.TARJETA||0);
  if($("cDiffTrans")) $("cDiffTrans").textContent = fmtDiffTag(c.diff?.TRANSFERENCIA||0);
  if($("cDiffTotal")) $("cDiffTotal").textContent = fmtDiffTag(c.diffTotal||0);

  const cp = $("cProducts");
  cp.innerHTML = "";
  if((c.products||[]).length===0){
    const div = document.createElement("div");
    div.className="muted";
    div.textContent = "Sin ventas en este rango.";
    cp.appendChild(div);
  }else{
    for(const p of (c.products||[]).slice(0,50)){
      const div = document.createElement("div");
      div.className="line";
      div.innerHTML = `<span>${p.qty} x ${escapeHtml(p.name)}</span><span><small>${escapeHtml(p.code)}</small></span>`;
      cp.appendChild(div);
    }
  }
}

async function deleteSavedClose(id){
  if(!requireCode("borrar cierre")) return;
  if(!confirm("¬øBorrar cierre guardado?")) return;
  await idbDel("closes", id);
  await renderSavedCloses();
  alert("Cierre borrado.");
}

async function copyClose(){
  const text = closeToText(state.lastClose);
  try{
    await navigator.clipboard.writeText(text);
    alert("Cierre copiado.");
  }catch{
    alert("No se pudo copiar autom√°ticamente.");
  }
}
function openCloseWhatsApp(){
  const text = closeToText(state.lastClose);
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
}
function generateClosePDF(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const html = closeToPrintableHTML(state.lastClose);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}
async function downloadClosePNG(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const node = $("closeBox");
  if(!node) return;

  if(window.html2canvas){
    try{
      await capturePNG(node, `cierre_${state.lastClose.dateKey}_${state.lastClose.fromHHMM.replace(":","")}-${state.lastClose.toHHMM.replace(":","")}.png`, 2);
      return;
    }catch(e){
      // sigue al aviso abajo
    }
  }
  alert("No se pudo generar PNG. Intenta con PDF.");
}


async function exportJSON(){
  const clients   = await idbAll("clients");
  const products  = await idbAll("products");
  const sales     = await idbAll("sales");
  const shipments = await idbAll("shipments");
  const closes    = await idbAll("closes");
  const meta      = await idbAll("meta");
  const movements = await idbAll("movements"); // ‚úÖ NUEVO

  const data = {
    exportedAt: new Date().toISOString(),
    settings: state.settings,
    clients, products, sales, shipments, closes, meta, movements
  };

  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "pos_boutique_backup.json";
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}

async function importJSON(file){
  const text = await file.text();
  const data = JSON.parse(text);
  if(!data || typeof data!=="object") throw new Error("JSON inv√°lido.");

  await idbClearAll();
  if(data.clients) for(const c of data.clients) await idbPut("clients", c);
  if(data.products)for(const p of data.products) await idbPut("products", p);
  if(data.sales)   for(const s of data.sales) await idbPut("sales", s);
  if(data.shipments) for(const s of data.shipments) await idbPut("shipments", s);
  if(data.closes) for(const c of data.closes) await idbPut("closes", c);
  if(data.meta)    for(const m of data.meta) await idbPut("meta", m);
  if(data.movements) for(const m of data.movements) await idbPut("movements", m);
  if(data.settings) state.settings = data.settings;

  await loadSettings();
  await refreshKPIs();
  refreshProductPicker();
  renderProducts();
  renderInventory();
  renderClients();
  renderReport("daily");
  renderShipments();
  updateReceiptPreview();
  buildClose();
  syncDiscUI();
  renderSavedCloses();
  alert("Backup importado.");
}
async function pickBackupFolder(){
  if(!window.showDirectoryPicker){
    alert("Tu navegador no soporta carpeta autom√°tica. Usa Chrome/Edge.");
    return;
  }
  // Evita: NotAllowedError: File picker already active
  if(!window.state) window.state = {};
  state._uiLocks = state._uiLocks || {};
  if(state._uiLocks.pickBackupFolder) return;
  state._uiLocks.pickBackupFolder = true;

  try{
    const handle = await window.showDirectoryPicker();
    if(!handle) return;
    state.backup = state.backup || {};
    state.backup.dirHandle = handle;
    alert("Carpeta de backups configurada ‚úÖ");
  }catch(err){
    // AbortError = el usuario cerr√≥/cancel√≥ el di√°logo (no es problema)
    if(err && (err.name === "AbortError" || err.message?.includes("aborted"))){
      // silencioso
    } else if(err && err.name === "NotAllowedError"){
      // si sigue ocurriendo, suele ser doble click; ya lo bloqueamos arriba
      console.warn("No permitido abrir selector de carpeta:", err);
    } else {
      console.error(err);
      alert("No se pudo seleccionar la carpeta. Intenta de nuevo.");
    }
  }finally{
    state._uiLocks.pickBackupFolder = false;
  }
}
async function autoBackupToFolder(tag="auto"){
  try{
    if(!state.backup?.enabled) return;

    // Si no hay carpeta elegida, hacemos fallback a descarga normal
    if(!state.backup?.dirHandle){
      await exportJSON();
      return;
    }

    const clients   = await idbAll("clients");
    const products  = await idbAll("products");
    const sales     = await idbAll("sales");
    const shipments = await idbAll("shipments");
    const closes    = await idbAll("closes");
    const meta      = await idbAll("meta");
    const movements = await idbAll("movements");

    const data = {
      exportedAt: new Date().toISOString(),
      tag,
      settings: state.settings,
      clients, products, sales, shipments, closes, meta, movements
    };

    const ts = new Date();
    const name =
      `backup_${tag}_` +
      ts.getFullYear() +
      String(ts.getMonth()+1).padStart(2,"0") +
      String(ts.getDate()).padStart(2,"0") + "_" +
      String(ts.getHours()).padStart(2,"0") +
      String(ts.getMinutes()).padStart(2,"0") +
      String(ts.getSeconds()).padStart(2,"0") +
      ".json";

    const fileHandle = await state.backup.dirHandle.getFileHandle(name, { create:true });
    const writable = await fileHandle.createWritable();
    await writable.write(new Blob([JSON.stringify(data,null,2)], {type:"application/json"}));
    await writable.close();
  }catch(e){
    console.warn("AutoBackup fall√≥:", e);
    // fallback a descarga
    try{ await exportJSON(); }catch(_){}
  }
}


async function refreshKPIs(){
  const clients = await idbAll("clients");
  const products= await idbAll("products");
  const sales   = await idbAll("sales");
  const shipments = await idbAll("shipments");

  const now = Date.now();
  let shiftStart = await getShiftStartTs();

  // Si no existe turno a√∫n, lo inicializamos al inicio del d√≠a
  if(!shiftStart){
    const d = new Date();
    d.setHours(0,0,0,0);
    shiftStart = d.getTime();
    await setShiftStartTs(shiftStart);
  }

  // Ventas del TURNO = desde shiftStart hasta ahora
  const turnoSales = sales.filter(s => Number(s.ts||0) >= shiftStart && Number(s.ts||0) <= now);
  const total = turnoSales.reduce((a,s)=>a+Number(s.total||0),0);

  const pending = shipments.filter(s=> (s.status||"PENDIENTE")==="PENDIENTE").length;

  const kClients = $("kClients"); if(kClients) kClients.textContent = clients.length;
  const kProducts= $("kProducts"); if(kProducts) kProducts.textContent = products.length;
  const kSalesToday = $("kSalesToday"); if(kSalesToday) kSalesToday.textContent = turnoSales.length;
  const kTotalToday = $("kTotalToday"); if(kTotalToday) kTotalToday.textContent = money(total);
  const kShipPending= $("kShipPending"); if(kShipPending) kShipPending.textContent = pending;

  // Opcional: cambia el t√≠tulo visual del panel para que diga TURNO ACTUAL
  const pill = document.querySelector(".sidecard .pill");
  if(pill) pill.textContent = "üíó TUS VENTAS TURNO ACTUAL";
}

function sanitizeSettings(){
  if(state.settings.envPngWidth===undefined) state.settings.envPngWidth = 360;
  if(state.settings.envPngScale===undefined) state.settings.envPngScale = 2;
  if(state.settings.envPdfWidthMM===undefined) state.settings.envPdfWidthMM = 80;
  if(state.settings.envPdfMarginMM===undefined) state.settings.envPdfMarginMM = 6;
}

async function loadSettings(){
  const meta = await idbGet("meta","settings");
  if(meta?.value) state.settings = meta.value;

  if(state.settings.autoPDF===undefined) state.settings.autoPDF = true;
  if(state.settings.autoPNG===undefined) state.settings.autoPNG = true;

  sanitizeSettings();

  $("sShopName").value = state.settings.shopName || "Tienda de Ropa";
  $("sAutoPDF").value = state.settings.autoPDF ? "1" : "0";
  $("sAutoPNG").value = state.settings.autoPNG ? "1" : "0";

  $("sEnvPngWidth").value = state.settings.envPngWidth;
  $("sEnvPngScale").value = state.settings.envPngScale;
  $("sEnvPdfWidth").value = state.settings.envPdfWidthMM;
  $("sEnvPdfMargin").value = state.settings.envPdfMarginMM;

  $("rShop").textContent = state.settings.shopName || "Tienda de Ropa";
  $("cShop").textContent = state.settings.shopName || "Tienda de Ropa";
}

async function saveSettings(){
  const prev = {...state.settings};

  const shopName = $("sShopName").value.trim() || "Tienda de Ropa";
  const autoPDF = $("sAutoPDF").value==="1";
  const autoPNG = $("sAutoPNG").value==="1";

  const envPngWidth = Number($("sEnvPngWidth").value||360);
  const envPngScale = Number($("sEnvPngScale").value||2);
  const envPdfWidthMM = Number($("sEnvPdfWidth").value||80);
  const envPdfMarginMM = Number($("sEnvPdfMargin").value||6);

  // Si cambian tama√±os ENV√çO, pedimos c√≥digo 363534
  const advancedChanged =
    Number(prev.envPngWidth||360) !== envPngWidth ||
    Number(prev.envPngScale||2) !== envPngScale ||
    Number(prev.envPdfWidthMM||80) !== envPdfWidthMM ||
    Number(prev.envPdfMarginMM||6) !== envPdfMarginMM;

  if(advancedChanged){
    if(!requireCode("cambiar tama√±os de impresi√≥n (ENV√çO)")) return;
  }

  state.settings.shopName = shopName;
  state.settings.autoPDF = autoPDF;
  state.settings.autoPNG = autoPNG;

  state.settings.envPngWidth = Math.max(260, Math.min(520, envPngWidth));
  state.settings.envPngScale = Math.max(1, Math.min(4, envPngScale));
  state.settings.envPdfWidthMM = Math.max(50, Math.min(120, envPdfWidthMM));
  state.settings.envPdfMarginMM = Math.max(0, Math.min(20, envPdfMarginMM));

  await idbPut("meta",{key:"settings", value: state.settings});
  alert("Ajustes guardados.");
  updateReceiptPreview();
  buildClose();
}
function getClientDraftFromForm(){
  const phone = $("cPhone")?.value?.trim() || "";
  const names = $("cNames")?.value?.trim() || "";
  const last  = $("cLast")?.value?.trim() || "";
  const addr  = $("cAddr")?.value?.trim() || "";
  const indic = $("cIndic")?.value?.trim() || "";

  if(!(phone || names || last || addr || indic)) return null; // nada escrito
  return { phone, names, last, addr, indic };
}

function syncClientDraftLive(){
  const draft = getClientDraftFromForm();

  // En ENVIO: el recibo SIEMPRE debe reflejar lo escrito
  // En MOSTRADOR: si escribes algo, tambi√©n lo reflejamos
  state.selectedClient = draft;

  updateReceiptPreview();
}


// ---------- Events ----------
function wireEvents(){
  if(!window.state) window.state = {};
  if(state._wired) return; // evita doble enlace de eventos
  state._wired = true;
  // Helpers (safe binding)
  const on = (id, ev, fn)=>{ const el = $(id); if(el) el.addEventListener(ev, fn); };
  const onClick = (id, fn)=>on(id, 'click', fn);
// Descuento (corrige IDs aqu√≠ (robusto)
  // En este sistema el input se llama: id="discValue"
  // Si ma√±ana cambias el id, solo agrega el nuevo aqu√≠.
  const discInput = $("discValue") || $("discountValue") || $("descuento") || $("discount");
  if(!discInput){
    // No es cr√≠tico: solo no habr√° descuento manual desde UI
    // (evitamos warnings ruidosos en consola)
  } else {
    const safeRecalc = ()=>{
      try{
        if(typeof recalcCartTotals === "function") recalcCartTotals();
        if(typeof calcTotals === "function") calcTotals();
      }catch(_){}
    };
    discInput.addEventListener("input", ()=>{
      const v = Number(discInput.value || 0);
      // soporta ambos formatos: state.discount.value o state.discount
      if(!window.state) window.state = {};
      if(typeof state.discount === "object" && state.discount){
        state.discount.value = v;
      } else {
        state.discount = { value: v };
      }
      safeRecalc();
      if(typeof updateReceiptPreview === "function") updateReceiptPreview();
    });
  }
  // ====== HAMBURGER / SIDEBAR TOGGLE ======
  const isMobile = ()=> window.matchMedia("(max-width: 980px)").matches;

  function applySavedMenuState(){
    const saved = localStorage.getItem("mt_sidebar_collapsed");
    if(saved === "1") document.body.classList.add("sidebar-collapsed");
    else document.body.classList.remove("sidebar-collapsed");
  }
  applySavedMenuState();

  function closeMobileSidebar(){
    document.body.classList.remove("sidebar-open");
  }

  onClick("btnToggle", ()=>{
    // Mobile: abre/cierra drawer
    if(isMobile()){
      document.body.classList.toggle("sidebar-open");
      return;
    }
    // Desktop: colapsa/expande sidebar
    document.body.classList.toggle("sidebar-collapsed");
    localStorage.setItem("mt_sidebar_collapsed", document.body.classList.contains("sidebar-collapsed") ? "1" : "0");
  });

  // Overlay click (solo m√≥vil)
  onClick("menuOverlay", closeMobileSidebar);

  // Si tocas un bot√≥n del men√∫, en m√≥vil cerramos el drawer
  const nav = $("nav");
  if(nav){
    nav.addEventListener("click", (e)=>{
      const btn = e.target.closest("button[data-view]");
      if(btn && isMobile()) closeMobileSidebar();
    });
  }

  // Escape para cerrar en m√≥vil
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape") closeMobileSidebar();
  });

  // Al cambiar tama√±o, limpia estados cruzados
  window.addEventListener("resize", ()=>{
    if(!isMobile()){
      document.body.classList.remove("sidebar-open");
    }
  });

  // üìÅ Elegir carpeta de Backups
  onClick("btnPickBackupFolder", async ()=>{
    try{
      await pickBackupFolder();
    }catch(e){
      console.error(e);
      alert("No se pudo abrir el selector de carpeta.\nUsa Chrome o Edge y abre el sistema en https o localhost.");
    }
  });
$("btnRepDaily").addEventListener("click", ()=>renderReport("daily"));
$("btnRepWeekly").addEventListener("click", ()=>renderReport("weekly"));
$("btnRepMonthly").addEventListener("click", ()=>renderReport("monthly"));

const btnRange = $("btnRepRange");
if(btnRange){
  btnRange.addEventListener("click", renderReportRange);
}

  // Nav
  $("nav").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-view]");
    if(!btn) return;
    if(!appReady) return;
    setView(btn.dataset.view);
  });

  // Hamburger toggle
  $("btnToggle").addEventListener("click", ()=>{
    $("nav").classList.toggle("hide");
  });

  // Descuento
onClick("btnApplyDisc", ()=>{
  const type = $("discType").value;
  const value = Number($("discValue").value||0);
  state.discount = { type, value };
  syncDiscUI();
  renderCart();
});

onClick("btnClearDisc", ()=>{
  state.discount = { type:"NONE", value:0 };
  syncDiscUI();
  renderCart();
});


  // Inventory
  $("invSearch").addEventListener("input", ()=>{ if(state.view==="inventory") renderInventory(); });
  $("btnInvRefresh").addEventListener("click", renderInventory);

  // Shipments
  $("shipSearch").addEventListener("input", renderShipments);
  $("shipFilter").addEventListener("change", renderShipments);
  $("btnShipRefresh").addEventListener("click", renderShipments);
  $("shipBody").addEventListener("click", async (e)=>{
    const view = e.target.closest("button[data-viewship]");
    const pay  = e.target.closest("button[data-payship]");
    const pend = e.target.closest("button[data-pendship]");
    const del  = e.target.closest("button[data-delship]");

    if(view){
      const id = view.dataset.viewship;
      const s = await idbGet("shipments", id);
      if(s){
        state.lastReceipt = s;
        updateReceiptPreview();
        setView("pos");
        alert("Env√≠o cargado en vista POS. Puedes generar WhatsApp/PDF/PNG. (No cuenta como venta hasta PAGADO)");
      }
    }
    if(pay){
      await markShipmentPaid(pay.dataset.payship);
    }
    if(pend){
      await markShipmentPending(pend.dataset.pendship);
      await renderShipments();
    }
    if(del){
      await deleteShipment(del.dataset.delship);
    }
  });

  // Cierre
  $("btnBuildClose").addEventListener("click", async ()=>{ await buildClose(); alert("Cierre generado ‚úÖ"); });
  $("btnSaveClose").addEventListener("click", saveClose);
  $("closeDate").addEventListener("change", async ()=>{ if(state.view==="close"){ await buildClose(); await renderSavedCloses(); } });
  $("closeFrom").addEventListener("change", ()=>{ if(state.view==="close") buildClose(); });
  $("closeTo").addEventListener("change", ()=>{ if(state.view==="close") buildClose(); });

  ["realCash","realCard","realTrans"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ if(state.view==="close") buildClose(); });
  });

  $("btnCloseListRefresh").addEventListener("click", renderSavedCloses);
  $("closeSavedBody").addEventListener("click", async (e)=>{
    const v = e.target.closest("button[data-viewclose]");
    const d = e.target.closest("button[data-delclose]");
    if(v) await viewSavedClose(v.dataset.viewclose);
    if(d) await deleteSavedClose(d.dataset.delclose);
  });

  $("btnCloseCopy").addEventListener("click", copyClose);
  $("btnClosePDF").addEventListener("click", generateClosePDF);
  $("btnClosePNG").addEventListener("click", downloadClosePNG);
  $("btnCloseWA").addEventListener("click", openCloseWhatsApp);

  // Scan click: si hay c√≥digo, agrega; si no, solo enfoca
  $("btnScan").addEventListener("click", async ()=>{
    const code = $("scanInput").value.trim();
    const qty = Number($("qtyInput").value||1);

    if(!code){
      $("scanInput").focus();
      $("scanInput").select();
      return;
    }
    const p = await getProductByCode(code);
    if(!p) { alert("No existe producto con c√≥digo: " + code); return; }
    cartAdd(p, qty);
    $("scanInput").value="";
    $("qtyInput").value=1;
    $("scanInput").focus();
  });

  // Scan Enter
  $("scanInput").addEventListener("keydown", async (e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      const code = $("scanInput").value.trim();
      const qty = Number($("qtyInput").value||1);
      if(!code) return;
      const p = await getProductByCode(code);
      if(!p) { alert("No existe producto con c√≥digo: " + code); return; }
      cartAdd(p, qty);
      $("scanInput").value="";
      $("qtyInput").value=1;
      $("scanInput").focus();
    }
  });

  // Search products for picker
  $("productSearch").addEventListener("input", refreshProductPicker);
  $("btnAddPicked").addEventListener("click", async ()=>{
    const code = $("productPicker").value;
    if(!code) return;
    const p = await getProductByCode(code);
    if(!p) return alert("Producto no existe.");
    cartAdd(p, Number($("qtyInput").value||1));
    $("qtyInput").value=1;
    $("scanInput").focus();
  });

  // Cart actions
  $("cartBody").addEventListener("click",(e)=>{
    const b = e.target.closest("button[data-act]");
    if(!b) return;
    const code = b.dataset.code;
    const act = b.dataset.act;
    if(act==="minus") cartInc(code,-1);
    if(act==="plus")  cartInc(code, 1);
    if(act==="del")   { state.cart = state.cart.filter(x=>x.code!==code); renderCart(); }
  });

  $("btnClearCart").addEventListener("click", cartClear);

  // Client find/save
  $("btnFindClient").addEventListener("click", async ()=>{
    const phone = $("cPhone").value.trim();
    if(!phone) return alert("Ingrese tel√©fono.");
    const c = await findClientByPhone(phone);
    if(!c){
      alert("No existe. Completa los datos y presiona Guardar.");
      state.selectedClient = null;
      updateReceiptPreview();
      return;
    }
    state.selectedClient = c;
    $("cNames").value = c.names || "";
    $("cLast").value  = c.last || "";
    $("cAddr").value  = c.addr || "";
    $("cIndic").value = c.indic || "";
    alert("Cliente cargado.");
    updateReceiptPreview();
  });

  $("btnSaveClient").addEventListener("click", saveClientFromForm);

  $("btnUseWalkIn").addEventListener("click", ()=>{
    if($("saleType").value==="ENVIO"){
      alert("En ENV√çO no se permite venta sin cliente.");
      return;
    }
    state.selectedClient = null;
    $("cPhone").value=""; $("cNames").value=""; $("cLast").value=""; $("cAddr").value=""; $("cIndic").value="";
    alert("Listo: venta MOSTRADOR sin cliente.");
    updateReceiptPreview();
  });

$("saleType").addEventListener("change", ()=>{
  if($("saleType").value==="ENVIO"){
    $("cPhone").focus();
  }
  syncClientDraftLive(); // refresca usando lo escrito
});


  $("payMethod").addEventListener("change", updateReceiptPreview);

  // Checkout
  $("btnCheckout").addEventListener("click", checkout);

  // Receipt buttons
  $("btnCopyReceipt").addEventListener("click", copyReceipt);
  $("btnPDF").addEventListener("click", generatePDF);
  $("btnDownloadReceipt").addEventListener("click", downloadReceiptPNG);
  $("btnWhatsApp").addEventListener("click", openWhatsApp);

  // Clients table actions
  $("clientsBody").addEventListener("click", async (e)=>{
    const use = e.target.closest("button[data-useclient]");
    const del = e.target.closest("button[data-delclient]");
    if(use){
      const phone = use.dataset.useclient;
      const c = await findClientByPhone(phone);
      if(c){
        state.selectedClient = c;
        $("cPhone").value=c.phone; $("cNames").value=c.names; $("cLast").value=c.last; $("cAddr").value=c.addr; $("cIndic").value=c.indic||"";
        setView("pos");
        updateReceiptPreview();
      }
    }
    if(del){
      if(!requireCode("borrar cliente")) return;
      const phone = del.dataset.delclient;
      if(confirm("¬øBorrar cliente "+phone+"?")){
        await idbDel("clients", phone);
        await refreshKPIs();
        renderClients();
      }
    }
  });

  $("clientSearch").addEventListener("input", renderClients);
  $("btnClientRefresh").addEventListener("click", renderClients);

  // Products actions
  $("btnSaveProduct").addEventListener("click", saveProductFromForm);
  $("prodSearch").addEventListener("input", renderProducts);
  $("btnProdRefresh").addEventListener("click", ()=>{ renderProducts(); refreshProductPicker(); });

  $("productsBody").addEventListener("click", async (e)=>{
    const fill = e.target.closest("button[data-fillprod]");
    const del  = e.target.closest("button[data-delprod]");
    if(fill){
      if(!requireCode("editar producto")) return;
      const code = fill.dataset.fillprod;
      const p = await getProductByCode(code);
      if(!p) return;
      $("pCode").value = p.code;
      $("pName").value = p.name;
      $("pPrice").value= p.price;
      $("pStock").value= p.stock;
      $("pCode").focus();
    }
    if(del){
      if(!requireCode("borrar producto")) return;
      const code = del.dataset.delprod;
      if(confirm("¬øBorrar producto "+code+"?")){
        await idbDel("products", code);
        await refreshKPIs();
        renderProducts();
        refreshProductPicker();
        renderInventory();
      }
    }
  });

  // Reports actions
 onClick("btnRepDaily", ()=>renderReport("daily"));
onClick("btnRepWeekly", ()=>renderReport("weekly"));
onClick("btnRepMonthly", ()=>renderReport("monthly"));


  $("salesBody").addEventListener("click", async (e)=>{
    const view = e.target.closest("button[data-viewsale]");
    const del  = e.target.closest("button[data-delsale]");
    if(view){
      const id = view.dataset.viewsale;
      const s = await idbGet("sales", id);
      if(s){
        state.lastReceipt = s;
        updateReceiptPreview();
        setView("pos");
        alert("Recibo cargado en vista POS. Puedes copiar/WhatsApp/PNG/PDF.");
      }
    }
    if(del){
      if(!requireCode("borrar venta")) return;
      const id = del.dataset.delsale;
      if(confirm("¬øBorrar venta?")){
        // Restock al borrar venta (solo turno actual en UI, pero aplica al ticket borrado)
        const sale = await idbGet("sales", id);
        if(sale && Array.isArray(sale.items)){
          await restoreStockForItems(sale.items, "VENTA", id, "Anulaci√≥n de venta");
        }
        await idbDel("sales", id);
        await refreshKPIs();
        renderReport("daily");
        buildClose();
      }
    }
  });

  // Backup / restore (con clave) 
  $("btnBackup").addEventListener("click", async ()=>{
    if(!requireBackupCode("exportar backup")) return;
    await exportJSON();
  });

  $("btnRestore").addEventListener("click", ()=>{
    if(!requireBackupCode("importar backup")) return;
    $("restoreFile").click();
  });

  $("restoreFile").addEventListener("change", async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{ await importJSON(file); }
    catch(err){ alert("Error importando: " + err.message); }
    e.target.value="";
  });

  // Live updates on receipt while typing (EN TIEMPO REAL)
["cPhone","cNames","cLast","cAddr"].forEach(id=>{
  const el = $(id);
  if(!el) return;
  el.addEventListener("input", syncClientDraftLive);
  el.addEventListener("change", syncClientDraftLive);
});

  // Focus scan input by pressing F2
 window.addEventListener("keydown",(e)=>{
  if(e.key === "F2"){
    e.preventDefault();
    const s = $("scanInput");
    if(!s) return;
    s.focus();
    s.select();
  }
});


  // Settings save
  const btnSave = $("btnSaveSettings");
if(btnSave) btnSave.addEventListener("click", saveSettings);


  // Kardex
  onClick("btnKRefresh", renderKardex);
  onClick("btnKClear", clearKardex);
  ["kSearch","kType"].forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener("input", ()=>renderKardex());
    el.addEventListener("change", ()=>renderKardex());
  });

}

// ---------- Init ----------
(async function init(){
  // Importante: cablear eventos ANTES de cualquier operaci√≥n async.
  // As√≠, si IndexedDB falla, la UI sigue respondiendo y muestra errores al intentar acciones.
  try{
    // wireEvents(); // (desactivado: se llamaba 2 veces)

  }catch(e){
    console.warn('wireEvents fall√≥', e);
  }
  try{
    db = await openDB();
    appReady = true;
    await loadSettings();
    syncDiscUI();
    renderCart();
    await refreshKPIs();
    await refreshProductPicker();
    await renderProducts();
    await renderInventory();
    await renderClients();
    await renderSavedCloses();
    updateReceiptPreview();

    // Fecha por defecto en cierre
    const cd = $("closeDate");
    if(cd && !cd.value) cd.value = todayKey();

    setView("pos");
  }catch(err){
    console.error(err);
    alert("Error iniciando el sistema: " + (err?.message || err));
  }
})();
(async function init(){
  try{
    db = await openDB();      // Abre IndexedDB
    appReady = true;         // üî• Aqu√≠ habilitas la app

    await loadSettings();
    await refreshKPIs();
    await refreshProductPicker();

    wireEvents();            // Ahora s√≠ conecta todos los botones
    setView("pos");          // Entra directo al POS
  }catch(err){
    console.error(err);
    alert("Error inicializando el sistema: " + err.message);
  }
})();


</script>
</body>
</html>
